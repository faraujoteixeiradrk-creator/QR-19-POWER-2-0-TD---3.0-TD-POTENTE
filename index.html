<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">DRK: Comparador Multitarifa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluimos QRCode.js y jsQR.min.js para el manejo de QR -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // --- TAILWIND CONFIGURATION ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            400: '#38bdf8', /* Lighter Blue for Active Hover */
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        powercup: {
                            50: '#f7fee7',
                            100: '#ecfccb',
                            400: '#a3e635', /* Lighter Green for Active Hover */
                            500: '#84cc16',
                            600: '#65a30d',
                            800: '#3f6212',
                            900: '#365314',
                            'yellow-flash': '#facc15',
                        },
                        // Nuevos colores para asegurar el verde en el flujo de resultados y CTA
                        'cta-green': {
                            500: '#16a34a', /* Usado para los ahorros */
                            600: '#15803d',
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos base y animaciones */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { border: 2px solid; }

        /* Estilos de los botones de selecci√≥n de tarifa (Landing Page) */
        .tariff-select-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        
        /* DRK Active Hover Styles (Default) */
        .drk-active .tariff-select-btn:hover {
            border-color: #0ea5e9; /* drk-500 */
            background-color: #f0f9ff; /* drk-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .drk-active .tariff-select-btn:hover .arrow-icon {
            color: #0ea5e9; /* drk-500 */
        }

        /* POWER CUP Active Hover Styles */
        .powercup-active .tariff-select-btn:hover {
            border-color: #84cc16; /* powercup-500 */
            background-color: #f7fee7; /* powercup-50 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(132, 204, 22, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .powercup-active .tariff-select-btn:hover .arrow-icon {
            color: #84cc16; /* powercup-500 */
        }

        .icon-wrapper {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .arrow-icon {
            margin-left: auto;
            font-size: 1.5rem;
            color: #94a3b8; /* slate-400 */
            transition: color 0.3s ease;
        }

        /* Estilos QR */
        #qr-content-wrapper { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        #qr-content-wrapper.active { max-height: 500px; opacity: 1; }
        #qr-visual-container { 
            position: relative; 
            display: inline-block; 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1rem; 
            border: 4px solid var(--qr-border-color, #0ea5e9); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        /* Texto central del QR */
        #qr-visual-container::before { 
            content: var(--qr-center-text, "DRK"); 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 20px; /* Tama√±o reducido para no cubrir tanto */
            font-weight: bold; 
            color: #ffffff; 
            background-color: var(--qr-center-bg, #0c4a6e); 
            padding: 4px 8px; /* Padding reducido */
            border-radius: 6px; 
            z-index: 10; 
            opacity: 0.95; 
            min-width: 60px;
            text-align: center;
        }
        
        /* Ocultar elementos dependiendo del tipo de tarifa */
        .hidden-period { display: none; }
        
        /* Estilos para el campo de pegado temporal (FIX para Ctrl+V) */
        #paste-catcher {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* Oculto por defecto */
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
            transition: all 0.15s ease-in-out;
            resize: none;
        }

        #paste-catcher.pasting-active {
            width: 200px; 
            height: 100px; 
            opacity: 0.01; /* Debe ser casi transparente, pero no 0 */
            z-index: 1000; /* Siempre visible cuando activo */
            border: 4px dashed var(--qr-border-color, #0ea5e9);
            background-color: white;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 drk-active">

    <!-- Navbar -->
    <div id="navbar" class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight cursor-pointer" onclick="resetToLanding()">
                <span id="app-logo-main">DRK</span> <span class="text-drk-500" id="app-logo-accent">Energ√≠a</span>
            </h1>
            <span class="text-xs bg-drk-800 px-2 py-1 rounded text-drk-100" id="app-subtitle">Selector</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="app" class="w-full max-w-lg mx-auto p-4 md:p-6 flex-grow">

        <!-- 1. Landing View -->
        <div id="landing-view" class="fade-in flex flex-col items-center justify-center min-h-[60vh] py-8">
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="landing-card">
                <div id="landing-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                <h2 id="landing-title" class="text-3xl font-black text-drk-900 mb-2 text-center">DRK COMPARADOR</h2>
                <p class="text-slate-500 mb-6 text-center">Selecciona el modo de comparaci√≥n y la tarifa que deseas analizar.</p>
                
                <!-- Comparison Mode Selector -->
                <div id="mode-selector-container" class="mb-8 pt-4 border-t border-slate-200">
                    <p class="text-sm font-bold text-drk-800 mb-3 text-center uppercase tracking-wider">MODO DE COMPARACI√ìN</p>
                    <div id="comparison-mode-selectors" class="flex flex-wrap justify-center gap-2 text-sm">
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-300 text-drk-700 bg-white hover:bg-drk-100 hover:border-drk-400">
                            <input type="radio" name="comparison_mode" value="drk_only" class="hidden">
                            <span class="font-semibold flex items-center justify-between w-full">DRK √önicamente<svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                        </label>
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-500 text-white bg-drk-500 hover:bg-drk-600">
                            <input type="radio" name="comparison_mode" value="drk_prioritized" class="hidden" checked>
                            <span class="font-semibold flex items-center justify-between w-full">DRK Prioritario<svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                        </label>
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-powercup-300 text-powercup-700 bg-white hover:bg-powercup-100 hover:border-powercup-400">
                            <input type="radio" name="comparison_mode" value="overall_best" class="hidden">
                            <span class="font-black flex flex-col items-center justify-center w-full leading-tight">
                                <span class="text-base">POWER CUP</span><span class="text-xs font-semibold -mt-0.5">Global</span>
                            </span>
                            <svg class="w-4 h-4 ml-1 checkmark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </label>
                    </div>
                </div>
                
                
                <!-- Tariff Selection Buttons -->
                <div class="w-full space-y-4">
                    <button onclick="selectTariffType('MULTICUPS')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">MULTICUPS</span>
                            <span class="block text-xs text-slate-500">Gestor de m√∫ltiples contratos (2.0TD + 3.0TD)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectTariffType('2.0TD')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Hogar / Peque√±o Negocio (Individual)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectTariffType('3.0TD')" class="tariff-select-btn group">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.18a2 2 0 0 0 1.51-.72L11 1l2 2h3.18a2 2 0 0 1 1.51.72L20 5h1.18a2 2 0 0 1 2 2z"></path><path d="M14 9H8v8h8V9z"></path></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                            <span class="block text-xs text-slate-500">Industria / Gran Consumo (Individual)</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <!-- QR Link Section -->
                <div id="pwa-install-section" class="mt-8 pt-4 border-t border-slate-200 text-center">
                    <label class="flex items-center justify-center cursor-pointer mb-3 text-drk-800 hover:text-drk-900 transition">
                        <input type="checkbox" id="qr-toggle-checkbox" class="h-4 w-4 text-drk-500 border-gray-300 rounded focus:ring-drk-500 mr-2">
                        <span class="text-xs font-bold uppercase tracking-wider underline decoration-drk-500 decoration-2 underline-offset-4">Abrir en el Movil</span>
                    </label>
                    <div id="qr-content-wrapper" class="opacity-0 max-h-0">
                        <div id="qr-visual-container" class="mx-auto w-44 h-44 p-2">
                            <div id="qr-code-container"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-3">Haz una foto del QR y √°brelo en tu m√≥vil.</p>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 2. MultiCups Saga View (Intermediate Step) -->
        <div id="multicups-saga-view" class="fade-in hidden flex flex-col items-center justify-center min-h-[60vh] py-8">
            <button onclick="resetToLanding()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver a selecci√≥n de modo
            </button>
            
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 border-drk-500" id="multicups-saga-card">
                <div id="initial-icon-bg-saga" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600 shadow-inner">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style>
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                </div>
                
                <h2 class="text-3xl font-black text-drk-900 mb-2 text-center">MULTICUPS</h2>
                <p class="text-slate-500 mb-6 text-center" id="saga-instruction-text">
                    Selecciona el tipo de contrato que deseas a√±adir.<br>
                    Total de suministros actuales: <span class="font-bold text-drk-800" id="saga-total-cups">0</span>
                </p>
                
                <p id="loading-status-saga" class="text-center text-sm text-slate-400 mt-4 mb-4">Cargando tarifas 2.0TD y 3.0TD...</p>

                <div id="saga-button-wrapper" class="w-full space-y-4 pt-4 border-t border-slate-200">
                    <button onclick="selectMultiCupType('2.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">2.0 TD</span>
                            <span class="block text-xs text-slate-500">Permite Esc√°ner QR, Imagen y Entrada Manual</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>

                    <button onclick="selectMultiCupType('3.0TD')" class="tariff-select-btn group border-drk-300 hover:border-drk-500">
                        <div class="icon-wrapper bg-drk-50 text-drk-600 group-hover:bg-drk-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.18a2 2 0 0 0 1.51-.72L11 1l2 2h3.18a2 2 0 0 1 1.51.72L20 5h1.18a2 2 0 0 1 2 2z"></path><path d="M14 9H8v8h8V9z"></path></svg>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-bold text-drk-900">3.0 TD</span>
                            <span class="block text-xs text-slate-500">Solo Entrada de Datos Manual</span>
                        </div>
                        <span class="arrow-icon group-hover:text-drk-500">&rarr;</span>
                    </button>
                </div>
                
                <button id="multicups-finalize-btn-saga" onclick="finalizeMultiCups()" class="w-full bg-cta-green-500 hover:bg-cta-green-600 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mt-8 hidden">
                    FINALIZAR Y COMPARAR (<span id="saga-finalize-count">0</span> Suministros)
                </button>
            </div>
        </div>

        <!-- 3. Initial Input View (Scan/Manual) -->
        <div id="initial-view" class="fade-in hidden">
            <button onclick="currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : resetToLanding()" class="mb-4 text-sm text-slate-500 hover:text-drk-600 flex items-center gap-1">
                &larr; Volver <span id="back-button-label">a selecci√≥n</span>
            </button>

            <div id="initial-card" class="bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 border-drk-500 relative">
                <div id="tariff-badge" class="absolute top-4 right-4 bg-drk-500 px-2 py-1 rounded-full text-white text-xs font-bold shadow-md">
                    <span id="current-tariff-label">2.0TD</span> - <span id="tariff-display-badge">0</span>
                </div>
                
                
                <div id="initial-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600"></div>
                
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Analizar Factura</h2>
                <p class="text-slate-500 mb-6" id="scan-instruction-text">Escanea el c√≥digo QR o introduce datos manualmente.</p>
                
                <div id="qr-buttons-container">
                    <button id="start-scan-btn" class="w-full bg-gradient-to-r from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>ESCANEAR QR AHORA</span>
                    </button>
                    <input type="file" id="image-file-input" accept="image/*" class="hidden">
                    <button id="upload-menu-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1m-4-5l-1-1m0 0l-1-1m0 0l-1-1M12 12v.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span>OPCIONES QR MANUAL</span>
                    </button>
                </div>
                <button id="manual-input-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3 mt-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>DATOS A MANO</span>
                </button>

                <button id="multicups-finalize-btn-main" class="hidden"></button>

                <p id="loading-status" class="text-center text-sm text-slate-400 mt-4 hidden">Cargando tarifas...</p>

            </div>
        </div>

        <!-- 4. Scanner View -->
        <div id="scanner-view" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700">Escaneando...</h2>
                <button id="stop-scan-btn" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">Cancelar</button>
            </div>
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl mb-4">
                <div id="interactive" class="viewport w-full h-full"></div>
                <div id="scanner-guide" class="absolute inset-0 border-2 border-drk-500 opacity-50 m-8 rounded-lg pointer-events-none"></div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none"><div class="w-64 h-1 bg-red-500 opacity-50"></div></div>
            </div>
            <p class="text-center text-sm text-slate-500 mb-4">Enfoca el c√≥digo QR de la CNMC.</p>
            <button id="capture-photo-btn" class="w-full bg-white border-2 border-drk-500 text-drk-800 font-bold py-3 rounded-xl shadow-sm flex items-center justify-center gap-2">Capturar Foto Manualmente</button>
        </div>

        <!-- 5. Results View -->
        <div id="results-view" class="hidden animate-fade-in-up">
            <!-- Banner de Empresa -->
            <div id="company-banner" class="mb-8 rounded-2xl overflow-hidden shadow-lg">
                <!-- El contenido del banner se generar√° din√°micamente seg√∫n la marca activa -->
            </div>
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mb-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> An√°lisis Completado
                </div>
                <h2 class="2xl font-black text-slate-800">Resultado del Estudio</h2>
                <p class="text-sm text-slate-500" id="results-cups-list">CUPS: <span class="font-mono text-slate-700" id="cups-value"></span></p>
            </div>

            <div id="result-card" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-8 relative">
                <div id="result-header" class="bg-gradient-to-r from-drk-800 to-drk-600 p-6 text-white text-center relative overflow-hidden">
                    <p class="uppercase tracking-widest text-xs font-semibold text-drk-100 mb-1" id="best-offer-label">LA MEJOR OPCI√ìN PARA TI ES</p>
                    <h2 id="best-offer-name" class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">Nombre Tarifa</h2>
                    <!-- offer.description del CSV -->
                    <p id="best-offer-desc" class="text-drk-100 text-sm opacity-90">Descripci√≥n</p> 
                </div>
                <div class="p-6">
                    <div class="flex flex-col gap-6">
                        <div class="text-center">
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Tu Ahorro Anual Estimado</p>
                            <p id="savings-estimate" class="text-5xl font-black text-cta-green-500 tracking-tight">- ‚Ç¨</p>
                        </div>
                        <div class="w-full grid grid-cols-2 text-center text-sm border-b pb-4 border-slate-100">
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-slate-400 text-xs font-semibold mb-2 uppercase">TU FACTURA ACTUAL</p>
                                <div class="mb-3">
                                    <p class="text-xl font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-period-cost-display">0,00 ‚Ç¨</p>
                                    <p class="text-xs text-slate-500 font-medium" id="old-period-days-label">Total Periodo</p> 
                                </div>
                                <div><p class="text-lg font-bold text-cta-red-500 line-through decoration-cta-red-500/50 decoration-2" id="old-annual-cost-display">0,00 ‚Ç¨/a√±o</p></div>
                            </div>
                            <div class="pl-2">
                                <p class="text-drk-800 text-xs font-semibold mb-2 uppercase" id="new-cost-label">TU NUEVO COSTE DRK</p>
                                <div class="mb-3">
                                    <p class="text-2xl font-black text-drk-900" id="new-monthly-cost-display">0,00 ‚Ç¨/mes</p>
                                    <p class="text-xs text-drk-800 font-medium" id="monthly-label">Estimado Mensual</p>
                                </div>
                                <div><p class="text-2xl font-black text-drk-900" id="new-annual-cost-display">0,00 ‚Ç¨/a√±o</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mb-8">
                <button id="send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                    <span>COPIAR COMPARATIVO</span>
                </button>
                <button onclick="document.getElementById('details-container').classList.toggle('hidden')" class="text-center text-drk-800 font-bold text-sm hover:underline flex items-center justify-center gap-1" id="details-toggle-btn">Ver desglose detallado del c√°lculo</button>
            </div>
            
            <div id="details-container" class="hidden space-y-6">
            </div>

            <div class="mt-8">
                <button onclick="resetToLanding()" class="w-full bg-white border-2 border-slate-200 hover:border-drk-500 text-slate-600 hover:text-drk-800 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2">
                    Realizar Nueva Comparaci√≥n
                </button>
            </div>
        </div>

        <!-- 6. Manual Input Modal -->
        <div id="manual-input-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="manual-modal-title">Entrada de Datos Manual</h3>
                
                <div id="manual-tariff-selector-wrapper" class="hidden mb-4">
                    <label for="manual-input-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="manual-input-tariff-select" onchange="toggleMultiCupsInputPeriods(this.value, 'input')" class="w-full p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Hogar/Negocio)</option>
                        <option value="3.0TD">3.0 TD (Industria/Gran Consumo)</option>
                    </select>
                </div>

                <div class="border-b border-slate-200 pb-3 mb-4 bg-slate-50 p-3 rounded-lg">
                    <h4 class="font-bold text-slate-800 mb-2">Datos Generales</h4>
                    <input type="text" id="input-cups" placeholder="N√∫mero CUPS" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    <input type="number" id="input-billing-days" placeholder="D√≠as Facturados" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 class="font-bold text-slate-800 mb-2">Potencias (kW)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.01" id="input-p1-kw" placeholder="P1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p2-kw" placeholder="P2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p3-kw" placeholder="P3" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p4-kw" placeholder="P4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p5-kw" placeholder="P5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="0.01" id="input-p6-kw" placeholder="P6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>
                
                <div class="border-b border-slate-200 pb-3 mb-3">
                    <h4 class="font-bold text-slate-800 mb-2">Energ√≠a (kWh)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="1" id="input-e1-kwh" placeholder="E1" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e2-kwh" placeholder="E2" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e3-kwh" placeholder="E3" class="p-2 border rounded text-sm focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e4-kwh" placeholder="E4" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e5-kwh" placeholder="E5" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                        <input type="number" step="1" id="input-e6-kwh" placeholder="E6" class="p-2 border rounded text-sm hidden-period focus:outline-none focus:border-2 focus:focus:border-drk-500">
                    </div>
                </div>

                <div class="pb-3 mb-3">
                    <input type="number" step="0.01" id="input-total-bill" placeholder="Total Factura (‚Ç¨)" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm font-bold focus:outline-none focus:border-2 focus:focus:border-drk-500">
                </div>
                
                <button id="execute-manual-input-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">CALCULAR</button>
                <button onclick="closeManualInputModal()" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 7. QR Confirmation Modal (MultiCups) -->
        <div id="qr-confirm-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-drk-800 mb-2">Confirmar Suministro</h3>
                <p class="text-sm text-slate-500 mb-4">Revisa los datos extra√≠dos y selecciona el tipo de tarifa para a√±adir a la lista.</p>

                <div class="mb-4" id="tariff-selector-wrapper">
                    <label for="confirm-tariff-select" class="block text-sm font-medium text-slate-700 text-left mb-1">Tipo de Tarifa</label>
                    <select id="confirm-tariff-select" class="w-full p-3 rounded-lg border border-slate-300 text-sm focus:outline-none focus:border-2 focus:border-drk-500">
                        <option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option>
                        <option value="3.0TD">3.0 TD (6 Periodos)</option>
                    </select>
                </div>

                <div id="qr-data-summary" class="bg-slate-50 p-3 rounded-lg text-sm mb-4">
                    </div>

                <button id="confirm-save-supply-btn" class="w-full bg-drk-500 hover:bg-drk-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">A√ëADIR A LA LISTA DE CUPS</button>
                <button onclick="document.getElementById('qr-confirm-modal').classList.add('hidden');" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 8. QR Options Modal (Upload/Paste) -->
        <div id="qr-options-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-qr-title">Seleccione Opci√≥n QR</h3>
                <button id="modal-upload-file-btn" class="w-full bg-drk-800 hover:bg-drk-900 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Subir Imagen</button>
                <button id="modal-paste-image-btn" class="w-full bg-drk-600 hover:bg-drk-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4">Pegar Imagen (CTRL+V)</button>
                <button onclick="document.getElementById('qr-options-modal').classList.add('hidden'); document.getElementById('qr-options-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl">Cancelar</button>
            </div>
        </div>

        <!-- 9. Send Offer Modal (Copy HTML) -->
        <div id="send-offer-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-client-data-title">Datos del Comercial y Cliente</h3>
                <p class="text-sm text-slate-600 mb-3">Rellene sus datos. El resumen profesional de la oferta se copiar√° a su portapapeles (Ctrl+V).</p>
                
                <input type="text" id="comercial-code-input" placeholder="C√ìDIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="text" id="client-name-input" placeholder="Nombre Cliente" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="tel" id="client-phone-input" placeholder="Tel√©fono" class="w-full mb-3 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                <input type="email" id="client-email-input" placeholder="Email" class="w-full mb-4 p-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-drk-500 outline-none">
                
                <!-- Nota informativa para iPhone -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start gap-2">
                        <span class="text-amber-600 text-xl">‚ö†Ô∏è</span>
                        <div class="text-xs text-amber-800">
                            <p class="font-bold mb-1">NOTA PARA USUARIOS DE iPHONE:</p>
                            <p class="leading-relaxed">Si copias desde iPhone, el formato puede no verse correctamente en algunos correos. Para mejor resultado:</p>
                            <ul class="mt-1 ml-3 space-y-0.5">
                                <li>‚úì Copia desde un <strong>ordenador</strong></li>
                                <li>‚úì O usa <strong>Gmail/Outlook web</strong> en el navegador m√≥vil</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <button id="execute-send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-black py-3 rounded-xl shadow-md mb-3">
                    üìß COPIAR COMPARATIVO (HTML)
                </button>
                <button onclick="document.getElementById('send-offer-modal').classList.add('hidden'); document.getElementById('send-offer-modal').classList.remove('flex');" class="w-full bg-slate-200 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- 9.8. Modal de Decisi√≥n (Mejor Opci√≥n vs Elegir) -->
        <div id="offer-decision-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white">
                    <h3 class="text-2xl font-black">‚úÖ C√°lculo Completado</h3>
                    <p class="text-drk-100 text-sm mt-1">Hemos encontrado ofertas con ahorro. ¬øC√≥mo quieres continuar?</p>
                </div>
                
                <!-- Content -->
                <div class="p-6">
                    <div class="flex flex-col gap-4">
                        <!-- Opci√≥n 1: Mejor Opci√≥n -->
                        <button onclick="selectBestOptionDirect()" class="text-left p-6 rounded-xl border-2 border-slate-300 bg-white hover:border-drk-500 hover:bg-drk-50 transition group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0 group-hover:bg-yellow-200">
                                    üèÜ
                                </div>
                                <div class="flex-1">
                                    <p class="font-black text-lg text-slate-900 mb-2">VER MEJOR OPCI√ìN</p>
                                    <p class="text-sm text-slate-600">Muestra autom√°ticamente la oferta con mayor ahorro y genera la comparativa</p>
                                </div>
                                <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                        
                        <!-- Opci√≥n 2: Elegir Manual -->
                        <button onclick="selectFromResults()" class="text-left p-6 rounded-xl border-2 border-slate-300 bg-white hover:border-drk-500 hover:bg-drk-50 transition group">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 group-hover:bg-blue-200">
                                    üìã
                                </div>
                                <div class="flex-1">
                                    <p class="font-black text-lg text-slate-900 mb-2">ELEGIR ENTRE RESULTADOS</p>
                                    <p class="text-sm text-slate-600">Revisa todas las ofertas con ahorro positivo y elige la que prefieras</p>
                                </div>
                                <svg class="w-6 h-6 text-slate-400 group-hover:text-drk-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Info adicional -->
                    <div class="mt-6 p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-600">
                            üí° <strong>Consejo:</strong> Si quieres ver r√°pidamente la mejor oferta, elige la primera opci√≥n. 
                            Si necesitas comparar varias opciones o el cliente tiene preferencias espec√≠ficas, elige la segunda.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9.9. Modal de Selecci√≥n de Oferta -->
        <div id="offer-selection-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="bg-gradient-to-r from-drk-600 to-drk-700 p-6 text-white flex-shrink-0">
                    <h3 class="text-2xl font-black">üìã SELECCIONA TU OFERTA</h3>
                    <p class="text-drk-100 text-sm mt-1">Hemos calculado todas las opciones con ahorro. Elige la que prefieras.</p>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Info del CUPS -->
                    <div class="bg-slate-50 rounded-lg p-4 mb-4">
                        <p class="text-xs font-bold text-slate-600 mb-2">üìã DATOS DEL SUMINISTRO</p>
                        <p class="text-sm font-mono" id="modal-selection-cups"></p>
                    </div>
                    
                    <!-- NUEVO: Controles de Filtrado y Ordenaci√≥n -->
                    <div class="bg-white border-2 border-drk-200 rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row gap-3">
                            <!-- Filtro por nombre -->
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-600 mb-2">üîç BUSCAR POR NOMBRE</label>
                                <input 
                                    type="text" 
                                    id="offer-search-input" 
                                    placeholder="Escribe nombre de comercializadora..."
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm"
                                    onkeyup="filterAndSortOffers()"
                                >
                            </div>
                            
                            <!-- Ordenaci√≥n -->
                            <div class="md:w-64">
                                <label class="block text-xs font-bold text-slate-600 mb-2">üìä ORDENAR POR</label>
                                <select 
                                    id="offer-sort-select" 
                                    class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-drk-500 focus:outline-none text-sm font-medium"
                                    onchange="filterAndSortOffers()"
                                >
                                    <option value="savings_desc">üí∞ Mayor ahorro primero</option>
                                    <option value="savings_asc">üí∏ Menor ahorro primero</option>
                                    <option value="name_asc">üî§ Nombre (A-Z)</option>
                                    <option value="name_desc">üî§ Nombre (Z-A)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Contador de resultados -->
                        <div class="mt-3 flex items-center justify-between">
                            <p class="text-xs text-slate-500">
                                <span class="font-bold text-drk-600" id="offers-visible-count">0</span> de <span id="offers-total-count">0</span> ofertas
                            </p>
                            <button 
                                onclick="clearOfferFilters()" 
                                class="text-xs text-drk-600 hover:text-drk-800 font-bold hover:underline"
                            >
                                üîÑ Limpiar filtros
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de ofertas con radio buttons -->
                    <div id="offers-radio-list" class="space-y-3 mb-6">
                        <!-- Se rellenar√° din√°micamente -->
                    </div>
                    
                    <!-- Mensaje cuando no hay resultados -->
                    <div id="no-offers-message" class="hidden text-center py-8">
                        <p class="text-slate-400 text-lg mb-2">üîç</p>
                        <p class="text-slate-600 font-bold">No se encontraron ofertas</p>
                        <p class="text-slate-500 text-sm">Prueba con otros criterios de b√∫squeda</p>
                    </div>
                </div>
                
                <!-- Footer con botones -->
                <div class="p-6 border-t border-slate-200 flex-shrink-0">
                    <div class="flex gap-3">
                        <button onclick="closeOfferSelectionModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-xl transition">
                            ‚Üê Volver
                        </button>
                        <button id="confirm-offer-selection-btn" class="flex-1 bg-drk-600 hover:bg-drk-700 text-white font-bold py-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                            Generar Comparativa ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10. Error/Message Modal -->
        <div id="error-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" id="error-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="error-title">¬°Atenci√≥n!</h3>
                <p id="error-message" class="text-slate-600 text-sm mb-6"></p>
                <div class="space-y-2">
                    <button onclick="hideErrorModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl">Entendido</button>
                    <button id="secondary-action-btn" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl text-sm mt-2 hidden">Acci√≥n Secundaria</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paste Catcher (Hidden element for capturing pasted image data) -->
    <textarea id="paste-catcher" aria-hidden="true" title="√Årea de pegado (invisible)"></textarea>

    <script>
        // --- CONFIGURACI√ìN DE TIPO DE TARIFAS ---
        // **ATENCI√ìN: Los IDs de las hojas deben ser p√∫blicos para funcionar (CSV)**
        // Eliminamos 6.1TD de la configuraci√≥n
        const TARIFF_CONFIG = {
            '2.0TD': { sheetId: '19CBiWVvxHoWW0fqdbSbLGs-hoISQGORAfebBztFYi3w', periods: 3, powerPeriods: 2, label: '2.0 TD', isHighVoltage: false, requiresQR: true, isMulti: false },
            '3.0TD': { sheetId: '18nieA7yMD9Ytc2Z3EnktoNDZokuMrBet_ETGyhNZDuo', periods: 6, powerPeriods: 6, label: '3.0 TD', isHighVoltage: true, requiresQR: false, isMulti: false },
            'MULTICUPS': { sheetId: 'MULTICUPS_MIXED_TARIF_SHEET_ID', periods: 6, powerPeriods: 6, label: 'MULTICUPS', isHighVoltage: false, requiresQR: true, isMulti: true, baseTariffType: '2.0TD' }
        };

        const BRANDS = {
            DRK: {
                NAME: 'DRK', ACCENT: 'drk-500', ACCENT_TEXT: 'Energ√≠a',
                TITLE: 'DRK COMPARADOR', // T√≠tulo en may√∫sculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/CALCULADORA-DRK-POWER-QR-CAMBIANDO-COLORES-DESCUENTO-y-DESCAR-TLF--2.0-TD-3.0-TD-6.1TD/',
                QR_TEXT: 'DRK',
                QR_BORDER_COLOR: '#0ea5e9', // drk-500
                QR_CENTER_BG: '#075985', // drk-800
                PRIMARY_BG_GRADIENT: 'from-drk-800 to-drk-600', 
                PRIMARY_BUTTON: 'from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-drk-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-drk-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-drk-800', SECONDARY_BG: 'bg-drk-50', SECONDARY_TEXT: 'text-drk-600', BORDER: 'border-drk-500',
                LOGO_SVG: `<svg class="w-8 h-8" viewBox="0 0 100 100" fill="none"><style>.drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}</style><circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/><circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/><circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/><circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/></svg>`,
                NAV_BG: 'bg-drk-900', NAV_SUBTITLE_BG: 'bg-drk-800', NAV_SUBTITLE_TEXT: 'text-drk-100'
            },
            POWER_CUP: {
                NAME: 'POWER CUP', ACCENT: 'powercup-500', ACCENT_TEXT: '',
                TITLE: 'POWER CUP COMPARADOR', // T√≠tulo en may√∫sculas
                QR_URL: 'https://faraujoteixeiradrk-creator.github.io/CALCULADORA-DRK-POWER-QR-CAMBIANDO-COLORES-DESCUENTO-y-DESCAR-TLF--2.0-TD-3.0-TD-6.1TD/',
                QR_TEXT: 'POWER',
                QR_BORDER_COLOR: '#84cc16', // powercup-500
                QR_CENTER_BG: '#3f6212', // powercup-800
                PRIMARY_BG_GRADIENT: 'from-powercup-900 to-powercup-800', 
                PRIMARY_BUTTON: 'from-powercup-600 to-powercup-800 hover:from-powercup-500 hover:to-powercup-900', // ESCANEAR QR
                SECONDARY_BUTTON_BG: 'bg-powercup-50', // OPCIONES QR MANUAL / DATOS A MANO BG
                SECONDARY_BUTTON_TEXT: 'text-powercup-800', // OPCIONES QR MANUAL / DATOS A MANO Text
                PRIMARY_TEXT: 'text-powercup-800', SECONDARY_BG: 'bg-powercup-50', SECONDARY_TEXT: 'text-powercup-600', BORDER: 'border-powercup-500',
                LOGO_SVG: `<svg width="40" height="40" viewBox="0 0 100 100" fill="none"><path d="M78 40V70C78 80.25 70.25 88 60 88H30C19.75 88 12 80.25 12 70V40C12 29.75 19.75 22 30 22H60C70.25 22 78 29.75 78 40Z" fill="#3f6212"/><circle cx="45" cy="95" r="5" fill="#365314" opacity="0.8"/><rect x="20" y="80" width="50" height="5" rx="2.5" fill="#365314"/><rect x="20" y="30" width="50" height="50" fill="#f7fee7" rx="5"/><rect x="25" y="65" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="50" width="40" height="10" rx="2" fill="#84cc16"/><rect x="25" y="35" width="40" height="10" rx="2" fill="#84cc16"/><path d="M80 20L60 35L70 45L50 60L75 60L65 80L85 65L75 55L85 45L65 45L75 25Z" fill="#facc15" stroke="#3f6212" stroke-width="2" stroke-linejoin="round"/><path d="M78 40C88 40 88 50 88 60C88 70 88 80 78 80" stroke="#3f6212" stroke-width="8" stroke-linecap="round"/></svg>`,
                NAV_BG: 'bg-powercup-900', NAV_SUBTITLE_BG: 'bg-powercup-800', NAV_SUBTITLE_TEXT: 'text-powercup-100'
            }
        };

        const EXTERNAL_APP_URL = 'https://faraujoteixeiradrk-creator.github.io/CALCULADORA-DRK-POWER-QR-CAMBIANDO-COLORES-DESCUENTO-y-DESCAR-TLF--2.0-TD-3.0-TD-6.1TD/';
        
        // Estado Global
        // Eliminamos 6.1TD del estado inicial
        let currentTariffs = {
            '2.0TD': [],
            '3.0TD': []
        };
        let currentTariffType = '2.0TD';
        let lastComparisonResult = null;
        let comparisonMode = 'drk_prioritized';
        let activeBrand = BRANDS.DRK;
        let qrCodeInstance = null; // Instancia de QRCode.js
        
        // Nuevas variables para selecci√≥n avanzada de ofertas
        let availableOffers = []; // Array de todas las ofertas con ahorro positivo
        let manuallySelectedOffer = null; // Oferta seleccionada manualmente

        // Estado Multicups
        let multiCupsData = [];
        let tempQrData = null; // Almacenamiento temporal para datos de QR antes de la confirmaci√≥n
        let multiCupsAddType = null; // NEW: Holds '2.0TD' or '3.0TD' when adding a single CUPS in MultiCups mode.
        
        // Variables Esc√°ner
        let scannerRunning = false;
        let stream = null, video = null, canvas = null, canvasCtx = null, animationFrameId = null;

        // --- FUNCIONES DE FORMATO ROBUSTAS ---
        const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
        const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
        const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);

        // Funci√≥n para obtener TODAS las ofertas √∫nicas usadas en los resultados
        function getWinningOffersPerType(results) {
            // Cambio: Ahora guardamos arrays de ofertas √∫nicas
            const winningOffers = { '2.0TD': [], '3.0TD': [] };
            let hasDrkWinner = false;
            
            results.forEach(resItem => {
                const type = resItem.originalTariffType;
                const winnerOffer = resItem.offer;
                
                // Track if any DRK offer won
                if (winnerOffer.isDrk && winnerOffer.name !== 'Tu Tarifa Actual') {
                    hasDrkWinner = true;
                }

                // Collect ALL unique winning offers for this type
                if (type === '2.0TD' || type === '3.0TD') {
                    const key = type;
                    
                    if (winnerOffer.name !== 'Tu Tarifa Actual') {
                        // Verificar si esta oferta ya est√° en el array (por nombre)
                        const alreadyExists = winningOffers[key].some(o => o.name === winnerOffer.name);
                        
                        if (!alreadyExists) {
                            winningOffers[key].push({
                                ...winnerOffer,
                                totalAnnual: resItem.totalAnnual
                            });
                        }
                    }
                }
            });

            return { winningOffers, hasDrkWinner };
        }
        
        // --- FUNCIONES DE MODALES Y UI ---
        
        window.hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
            cleanupPasteCatcher();
        };

        function setModalContent(msg, title, isError) {
            const brand = activeBrand;
            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = msg;

            if (isError) {
                document.getElementById('error-icon').className = "w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4";
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            } else {
                document.getElementById('error-icon').className = `w-12 h-12 bg-${basePrefix}-100 text-${basePrefix}-500 rounded-full flex items-center justify-center mx-auto mb-4`;
                document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            if (mainButton) {
                mainButton.textContent = "Entendido";
                mainButton.onclick = hideErrorModal;
            }

            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
            
            const secondaryBtn = document.getElementById('secondary-action-btn');
            if (secondaryBtn) secondaryBtn.classList.add('hidden');
        }

        window.showMessageModal = (msg, title="√âxito") => setModalContent(msg, title, false);
        window.showErrorModal = (msg, title="¬°Atenci√≥n!") => setModalContent(msg, title, true);
        
        function cleanupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            pasteCatcher.classList.remove('pasting-active');
            pasteCatcher.blur();  
            pasteCatcher.style.width = '0';
            pasteCatcher.style.height = '0';
            pasteCatcher.style.zIndex = '-1';
            pasteCatcher.style.pointerEvents = 'none';
            pasteCatcher.value = '';  
        }

        function showPasteModal(onCancel) {
            const pasteCatcher = document.getElementById('paste-catcher');
            
            // 1. Activar el campo de pegado
            pasteCatcher.classList.add('pasting-active');
            
            // Intentar asegurar el foco despu√©s de un breve momento para mayor fiabilidad.
            setTimeout(() => {
                pasteCatcher.focus();
            }, 50);
            
            // 2. Establecer contenido del modal
            setModalContent("Con el cuadro de texto invisible enfocado, pulse Ctrl+V (o Cmd+V) para pegar la imagen de la factura.", "Esperando Pegado (Ctrl+V)", false);

            // 3. Configurar el bot√≥n de Cancelar din√°micamente
            let secondaryBtn = document.getElementById('secondary-action-btn');
            secondaryBtn.textContent = "Cancelar Pegado";
            secondaryBtn.onclick = () => { onCancel(); hideErrorModal(); };
            secondaryBtn.classList.remove('hidden');
            
            // 4. Configurar bot√≥n principal para que tambi√©n cancele
            const mainButton = document.querySelector('#error-modal button:not(#secondary-action-btn)');
            mainButton.textContent = "Continuar Pegando";  
            mainButton.onclick = () => { hideErrorModal(); };
        }
        
        function setupPasteCatcher() {
            const pasteCatcher = document.getElementById('paste-catcher');
            const modalPasteBtn = document.getElementById('modal-paste-image-btn');
            
            modalPasteBtn.addEventListener('click', () => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                showPasteModal(cleanupPasteCatcher);
            });

            pasteCatcher.addEventListener('paste', (e) => {
                e.preventDefault();
                hideErrorModal();
                cleanupPasteCatcher();
                
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let imageFound = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            decodeQRFromImage(file);
                            imageFound = true;
                            break;
                        }
                    }
                }
                
                if (!imageFound) window.showErrorModal("No se detect√≥ ninguna imagen en el portapapeles.");
            });
        }
        
        // Funci√≥n para aplicar estilos de marca
        function applyBrandStyles(brand) {
            activeBrand = brand;
            const isDrk = brand.NAME.includes('DRK');
            
            const accent500 = isDrk ? 'drk-500' : 'powercup-500';
            const bg50 = isDrk ? 'bg-drk-50' : 'bg-powercup-50';
            const text800 = isDrk ? 'text-drk-800' : 'text-powercup-800';
            const borderColor = isDrk ? 'border-drk-500' : 'border-powercup-500';
            
            // --- CORE BRAND SWITCH (BODY CLASS) ---
            document.body.classList.toggle('powercup-active', !isDrk);
            document.body.classList.toggle('drk-active', isDrk);

            // 1. NAVBAR
            document.getElementById('app-logo-main').textContent = isDrk ? 'DRK' : 'POWER';
            document.getElementById('app-logo-accent').textContent = brand.ACCENT_TEXT;
            document.getElementById('app-logo-accent').className = `text-${brand.ACCENT}`;

            document.getElementById('navbar').className = `w-full ${brand.NAV_BG} text-white p-4 shadow-md sticky top-0 z-50 transition-colors duration-300`;
            document.getElementById('app-subtitle').className = `text-xs ${brand.NAV_SUBTITLE_BG} px-2 py-1 rounded ${brand.NAV_SUBTITLE_TEXT}`;

            // 2. LANDING PAGE CONTENT
            document.getElementById('landing-title').textContent = brand.TITLE; // Set main title in CAPS
            document.getElementById('landing-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('landing-icon-bg').innerHTML = brand.LOGO_SVG; // Set main logo

            // 3. INITIAL VIEW ICON (Used when user proceeds to scan view)
            document.getElementById('initial-icon-bg').className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
            document.getElementById('initial-icon-bg').innerHTML = brand.LOGO_SVG;
            // Also apply to Saga View
            const sagaIcon = document.getElementById('initial-icon-bg-saga');
            if (sagaIcon) {
                sagaIcon.className = `w-16 h-16 ${bg50} rounded-full flex items-center justify-center mx-auto mb-4 ${text800} shadow-inner`;
                sagaIcon.innerHTML = brand.LOGO_SVG;
            }
            
            // 4. MAIN ACTION BUTTONS (Scanner/Input View)
            const primaryButtonClass = `w-full bg-gradient-to-r ${brand.PRIMARY_BUTTON} text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3`;
            const startScanBtn = document.getElementById('start-scan-btn');
            if (startScanBtn) startScanBtn.className = primaryButtonClass; // Apply to scan button if visible

            const secondaryButtonBase = `w-full ${brand.SECONDARY_BUTTON_BG} ${isDrk ? 'hover:bg-drk-100' : 'hover:bg-powercup-100'} ${brand.SECONDARY_BUTTON_TEXT} font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3`;
            const uploadMenuBtn = document.getElementById('upload-menu-btn');
            if (uploadMenuBtn) uploadMenuBtn.className = secondaryButtonBase; // Apply to upload button if visible
            
            // Apply unique style to Manual Input button
            const manualInputBtn = document.getElementById('manual-input-btn');
            if (manualInputBtn) {
                // Remove all previous style classes related to color/bg/hover
                manualInputBtn.className = manualInputBtn.className.split(' ').filter(c => 
                    !c.startsWith('bg-') && !c.startsWith('hover:bg-') && !c.startsWith('text-') && !c.includes('from-') && !c.includes('to-')
                ).join(' ');
                
                // If QR is hidden (3.0TD individual flow), use the Primary style for manual input
                const isManualPrimary = !isDrk && currentTariffType !== 'MULTICUPS' && !TARIFF_CONFIG[currentTariffType]?.requiresQR;
                
                if (isManualPrimary) {
                    manualInputBtn.classList.add('w-full', 'text-white', 'font-bold', 'py-4', 'px-6', 'rounded-2xl', 'shadow-lg', 'transform', 'transition', 'active:scale-95', 'flex', 'items-center', 'justify-center', 'gap-3');
                    // A√±adir clases de gradiente por separado
                    const gradientClasses = isDrk 
                        ? ['bg-gradient-to-r', 'from-drk-600', 'to-drk-800', 'hover:from-drk-700', 'hover:to-drk-900']
                        : ['bg-gradient-to-r', 'from-powercup-600', 'to-powercup-800', 'hover:from-powercup-500', 'hover:to-powercup-900'];
                    manualInputBtn.classList.add(...gradientClasses);
                } else { // DRK active, MULTICUPS, or 2.0TD flow (uses secondary style)
                    manualInputBtn.classList.add('w-full', 'font-bold', 'py-3', 'px-6', 'rounded-xl', 'shadow-sm', 'transform', 'transition', 'active:scale-95', ...brand.SECONDARY_BUTTON_BG.split(' '), ...brand.SECONDARY_BUTTON_TEXT.split(' '));
                }

                // Re-add mt-3 if QR buttons are visible
                if (!document.getElementById('qr-buttons-container')?.classList.contains('hidden')) {
                    manualInputBtn.classList.add('mt-3');
                } else {
                    manualInputBtn.classList.remove('mt-3');
                }
            }
            
            const focusColorClass = isDrk ? 'focus:border-drk-500' : 'focus:border-powercup-500';  
            const calcBtnBg = isDrk ? 'bg-drk-500 hover:bg-drk-600' : 'bg-powercup-500 hover:bg-powercup-600';
            
            // 5. MANUAL INPUT MODAL STYLES
            const manualModal = document.getElementById('manual-input-modal');
            manualModal.querySelector('h3#manual-modal-title').className = `text-xl font-bold ${text800} mb-4`;
            manualModal.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                input.classList.remove('focus:border-drk-500', 'focus:border-powercup-500');
                input.classList.add(focusColorClass);
            });
            manualModal.querySelector('#execute-manual-input-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 6. QR OPTIONS MODAL STYLES (Modal 8)
            const qrOptionsModal = document.getElementById('qr-options-modal');
            qrOptionsModal.querySelector('h3#modal-qr-title').className = `text-xl font-bold ${text800} mb-4`;

            const uploadBtn = document.getElementById('modal-upload-file-btn');
            const pasteBtn = document.getElementById('modal-paste-image-btn');
            
            if (uploadBtn) {
                uploadBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3 transform transition active:scale-95 ${isDrk ? 'bg-drk-800 hover:bg-drk-900' : 'bg-powercup-800 hover:bg-powercup-900'}`;
            }

            if (pasteBtn) {
                pasteBtn.className = `w-full text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4 transform transition active:scale-95 ${isDrk ? 'bg-drk-600 hover:bg-drk-800' : 'bg-powercup-600 hover:bg-powercup-800'}`;
            }

            // 7. QR CONFIRM MODAL STYLES (Modal 7)
            const qrConfirmModal = document.getElementById('qr-confirm-modal');
            qrConfirmModal.querySelector('h3').className = `text-xl font-bold ${text800} mb-2`;
            qrConfirmModal.querySelector('#confirm-save-supply-btn').className = `w-full text-white font-bold py-3 rounded-xl shadow-md mb-3 ${calcBtnBg}`;

            // 8. SCANNER VIEW
            document.getElementById('scanner-guide').classList.remove('border-drk-500', 'border-powercup-500');
            document.getElementById('scanner-guide').classList.add(borderColor);
            
            const captureBtn = document.getElementById('capture-photo-btn');
            if (captureBtn) {
                captureBtn.classList.remove('border-drk-500', 'text-drk-800', 'border-powercup-500', 'text-powercup-800');
                captureBtn.classList.add('border-2', 'bg-white', borderColor, text800);
            }

            document.getElementById('paste-catcher').style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);


            // 9. Result Header Gradient & Card Borders
            document.getElementById('result-header').className = `bg-gradient-to-r ${brand.PRIMARY_BG_GRADIENT} p-6 text-white text-center relative overflow-hidden`;
            document.getElementById('initial-card').className = `bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 ${borderColor} relative`;
            document.getElementById('landing-card').className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor}`;
            
            const sagaCard = document.getElementById('multicups-saga-card');
            if (sagaCard) sagaCard.className = `bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full border-t-4 ${borderColor} relative`;

            // 10. TARIFF BADGE COLOR (In Initial View)
            const tariffBadge = document.getElementById('tariff-badge');
            tariffBadge.classList.remove('bg-drk-500', 'bg-powercup-500');  
            tariffBadge.classList.add(`bg-${accent500}`);

            // 11. Landing Page Tariff Buttons 
            document.querySelectorAll('.tariff-select-btn').forEach(btn => {
                const iconWrapper = btn.querySelector('.icon-wrapper');
                const arrowIcon = btn.querySelector('.arrow-icon');
                
                // Limpiar clases de color
                iconWrapper.className = iconWrapper.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && !c.startsWith('group-hover')).join(' ');
                arrowIcon.classList.remove('group-hover:text-drk-500', 'group-hover:text-powercup-500');
                btn.classList.remove('border-drk-300', 'hover:border-drk-500', 'border-powercup-300', 'hover:border-powercup-500');

                if (isDrk) {
                    iconWrapper.classList.add('bg-drk-50', 'group-hover:bg-drk-100', 'text-drk-600');
                    arrowIcon.classList.add('group-hover:text-drk-500');
                    btn.classList.add('border-drk-300', 'hover:border-drk-500');
                } else {
                    iconWrapper.classList.add('bg-powercup-50', 'group-hover:bg-powercup-100', 'text-powercup-600');
                    arrowIcon.classList.add('group-hover:text-powercup-500');
                    btn.classList.add('border-powercup-300', 'hover:border-powercup-500');
                }
            });
        }
        
        // --- FUNCIONES DE LIMPIEZA ---

        function clearManualInputs(prefix = 'input') {
            document.getElementById(`${prefix}-cups`).value = '';
            document.getElementById(`${prefix}-billing-days`).value = '';
            document.getElementById(`${prefix}-total-bill`).value = '';
            for (let i = 1; i <= 6; i++) {
                const pInput = document.getElementById(`${prefix}-p${i}-kw`);
                if (pInput) pInput.value = '';
                const eInput = document.getElementById(`${prefix}-e${i}-kwh`);
                if (eInput) eInput.value = '';
            }
        }
        
        function closeManualInputModal() {
            document.getElementById('manual-input-modal').classList.add('hidden');
            document.getElementById('manual-input-modal').classList.remove('flex');
            // Si est√°bamos en modo MultiCups, volvemos al selector 2.0/3.0
            if (currentTariffType === 'MULTICUPS') {
                showMultiCupsSagaView();
            }
        }

        function resetToLanding() {
            stopScanner();
            lastComparisonResult = null;
            multiCupsData = []; // Limpiar datos de multicups
            multiCupsAddType = null; // NEW: Reset sub-type
            
            // Restaurar la marca activa seg√∫n el modo de comparaci√≥n
            const brandToApply = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
            applyBrandStyles(brandToApply);  
            
            // Asegurarse de que el radio button correcto est√© checked y dispare el evento para el branding.
            const selectorInput = document.querySelector(`input[name="comparison_mode"][value="${comparisonMode}"]`);
            if (selectorInput) {
                selectorInput.checked = true;
                updateComparisonMode(comparisonMode); // Llamar directamente para asegurar el styling
            }

            document.getElementById('landing-view').classList.remove('hidden');
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.add('hidden'); // NEW: Cleanup saga view
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('manual-input-modal').classList.add('hidden');  
            document.getElementById('manual-input-modal').classList.remove('flex');
            
            document.getElementById('multicups-finalize-btn-main')?.classList.add('hidden'); // Old MultiCups button
            document.getElementById('manual-tariff-selector-wrapper').classList.add('hidden');

            document.querySelectorAll('.hidden-period').forEach(el => el.style.display = 'none');
            document.getElementById('tariff-display-badge').textContent = '0'; // Resetear el contador de tarifas
        }

        function toggleMultiCupsInputPeriods(tariffType, prefix = 'input') {
            // Eliminamos la referencia a 6.1TD en la comprobaci√≥n
            const isHighVoltage = tariffType === '3.0TD';
            const periods = document.querySelectorAll(`[id^="${prefix}-p3-kw"], [id^="${prefix}-p4-kw"], [id^="${prefix}-p5-kw"], [id^="${prefix}-p6-kw"], [id^="${prefix}-e4-kwh"], [id^="${prefix}-e5-kwh"], [id^="${prefix}-e6-kwh"]`);
            
            periods.forEach(el => {
                el.style.display = isHighVoltage ? 'block' : 'none';
            });
            // Ocultar/Mostrar campos de E1/E2/E3
            document.getElementById('input-e1-kwh').placeholder = isHighVoltage ? 'E1' : 'E1 (Punta)';
            document.getElementById('input-e2-kwh').placeholder = isHighVoltage ? 'E2' : 'E2 (Llano)';
            document.getElementById('input-e3-kwh').placeholder = isHighVoltage ? 'E3' : 'E3 (Valle)';
        }

        function selectTariffType(type) {
            currentTariffType = type;
            const config = TARIFF_CONFIG[type];
            const qrButtonsContainer = document.getElementById('qr-buttons-container');

            clearManualInputs();  

            if (config.isMulti) {
                // NEW: FLujo MULTICUPS: Va a la vista SAGA intermedia
                multiCupsData = [];  
                multiCupsAddType = null; // Reset sub-type
                
                document.getElementById('landing-view').classList.add('hidden');
                showMultiCupsSagaView();

                // Forzar carga de tarifas 2.0TD y 3.0TD
                fetchTariffsForMultiCups();
                
            } else {
                // Flujo Individual (2.0TD, 3.0TD)
                document.getElementById('manual-input-btn').textContent = "DATOS A MANO";
                document.getElementById('multicups-finalize-btn-main').classList.add('hidden');
                
                // --- FIX: Loading status displayed during fetch (Issue 1) ---
                document.getElementById('loading-status').textContent = `Cargando tarifas ${config.label}...`;
                document.getElementById('loading-status').classList.remove('hidden');
                document.getElementById('tariff-display-badge').textContent = '0';

                // --- FIX: 3.0TD always manual ---
                if (config.requiresQR && type === '2.0TD') { // 2.0TD is the only single tariff with QR
                    qrButtonsContainer.classList.remove('hidden');
                    document.getElementById('manual-input-btn').classList.add('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Escanea el c√≥digo QR o introduce datos manualmente.";
                } else { // 3.0TD (Siempre manual)
                    qrButtonsContainer.classList.add('hidden');
                    document.getElementById('manual-input-btn').classList.remove('mt-3');
                    document.getElementById('scan-instruction-text').textContent = "Introduce los datos de la factura manualmente.";
                    document.getElementById('qr-toggle-checkbox').checked = false;
                    document.getElementById('qr-content-wrapper').classList.remove('active');
                }

                document.getElementById('current-tariff-label').textContent = config.label;
                document.getElementById('app-subtitle').textContent = `Comparador ${config.label}`;
                
                // Mostrar/Ocultar inputs P3-P6/E4-E6
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                document.getElementById('landing-view').classList.add('hidden');
                document.getElementById('initial-view').classList.remove('hidden');
                
                // Cargar tarifas al seleccionar tipo
                fetchTariffsFromSheet(currentTariffType);

                if (document.getElementById('qr-toggle-checkbox').checked) {
                    generateQRCode(activeBrand);
                }
            }
        }
        
        function generateQRCode(brand) {
            const qrContainer = document.getElementById('qr-code-container');
            const qrVisualContainer = document.getElementById('qr-visual-container');

            // En modo MULTICUPS el QR siempre enlaza con 2.0TD ya que es el √∫nico compatible con QR
            const tariffParam = currentTariffType === 'MULTICUPS' ? '2.0TD' : currentTariffType;  
            const fullUrl = `${brand.QR_URL}?tariff=${tariffParam}`;  

            qrContainer.innerHTML = '';
            qrCodeInstance = null;

            qrVisualContainer.style.setProperty('--qr-center-text', `'${brand.QR_TEXT}'`);
            qrVisualContainer.style.setProperty('--qr-border-color', brand.QR_BORDER_COLOR);
            qrVisualContainer.style.setProperty('--qr-center-bg', brand.QR_CENTER_BG);
            
            qrCodeInstance = new QRCode(qrContainer, {
                text: fullUrl,
                width: 140,
                height: 140,
                colorDark : brand.QR_CENTER_BG,
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- C√ÅLCULOS Y COMPARACI√ìN INDIVIDUAL/MULTICUPS ---
        
        function calculateDays(startDateStr, endDateStr) {
             try {
                 const [d1, m1, y1] = startDateStr.split('/').map(Number);
                 const [d2, m2, y2] = endDateStr.split('/').map(Number);

                 const date1 = new Date(y1, m1 - 1, d1);
                 const date2 = new Date(y2, m2 - 1, d2);
                 
                 if (isNaN(date1.getTime()) || isNaN(date2.getTime())) return 30;

                 const ONE_DAY_MS = 1000 * 60 * 60 * 24;
                 const diffDays = (date2.getTime() - date1.getTime()) / ONE_DAY_MS;
                 return Math.round(diffDays) + 1;
             } catch (e) {
                 return 30;
             }
        }
        
        const formatIsoToDmy = (iso) => {
             if (!iso) return null;
             const parts = iso.split('-');
             if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;  
             return null;
        };

        function calculateTariffCost(tariff, data, tariffType) {
            const IVA_RATE = 0.21;
            const IE_RATE = 0.05113; // Impuesto El√©ctrico base
            const ANNUAL_DAYS = 365;
            const config = TARIFF_CONFIG[tariffType];  
            
            let subPower = 0;
            let powerCosts = [];
            
            // C√°lculo de Coste de Potencia
            for (let i = 1; i <= (config?.powerPeriods || 6); i++) {
                // Usamos 6 por defecto si no est√° definido (aunque TARIFF_CONFIG est√° bien definido ahora)
                const kw = data[`potencia_p${i}_kw`] || 0;
                const priceAnnual = tariff[`p_potencia_${i}`] || 0;
                const priceDay = priceAnnual / ANNUAL_DAYS;
                const cost = kw * data.dias_facturados * priceDay;
                subPower += cost;
                powerCosts.push({ period: i, cost: cost, priceDay: priceDay, kw: kw, priceAnnual: priceAnnual });
            }

            let subEnergy = 0;
            let energyCosts = [];
            
            // L√≥gica de consumo: usa los campos del data object
            for (let i = 1; i <= (config?.periods || 6); i++) {
                let kwh = 0;
                let price = 0;

                if (tariffType === '2.0TD') {
                    // 2.0TD usa nombres de campo espec√≠ficos para consumo: punta, llano, valle.
                    kwh = i === 1 ? data.consumo_punta : i === 2 ? data.consumo_llano : i === 3 ? data.consumo_valle : 0;
                    price = tariff[`p${i}_price`] || 0;
                } else {
                    // 3.0TD (y 6.1TD, aunque este √∫ltimo se elimin√≥ de la UI, el c√°lculo usa la estructura de 6 periodos)
                    kwh = data[`consumo_p${i}`] || 0;
                    price = tariff[`p${i}_price`] || 0;
                }
                
                const cost = kwh * price;
                energyCosts.push({ period: i, cost: cost, price: price, kwh: kwh });
                subEnergy += cost;
            }

            // Aplicar Descuento
            const discountRate = (tariff.descuento || 0) / 100;
            const discountAmount = subEnergy * discountRate;
            const subEnergyNet = subEnergy - discountAmount;

            // Base Imponible e Impuestos
            const subBase = subPower + subEnergyNet;
            const costIE = subBase * IE_RATE; // Impuesto El√©ctrico
            const baseImp = subBase + costIE;
            const costIVA = baseImp * IVA_RATE;
            const totalPeriod = baseImp + costIVA;
            
            // C√°lculo Anualizado
            const factorAnual = ANNUAL_DAYS / (data.dias_facturados || 30); // Prevenir divisi√≥n por cero/NaN
            const totalAnnual = totalPeriod * factorAnual;
            const originalBillAnnual = data.importe_total * factorAnual;

            const result = {
                ...data,
                tariffType: tariffType, // Tipo de tarifa usada en el c√°lculo (e.g. 2.0TD)
                powerCosts, energyCosts,
                subPower, subEnergy, subEnergyNet,
                discountRate, discountAmount,
                subBase, costIE, baseImp, costIVA, totalPeriod, totalAnnual,
                originalBillAnnual,
                savings: originalBillAnnual - totalAnnual,
                offer: tariff,
                ieRate: IE_RATE
            };
            
            // Si el ahorro es negativo, forzar la tarifa actual como mejor
            if (result.savings <= 0) {
                result.isNegativeSavings = true;
                result.savings = 0;
                result.totalAnnual = result.originalBillAnnual;  
                result.offer = { name: "Tu Tarifa Actual", description: "Es la mejor opci√≥n detectada", isDrk: false };
            }
            
            return result;
        }

        function compareOffers(data) {
            try {
                console.log('compareOffers called with data:', data);
                console.log('currentTariffType:', currentTariffType);
                
                const tariffType = currentTariffType;  
                const tariffsToCompare = currentTariffs[tariffType] || [];

                console.log(`Tarifas disponibles para ${tariffType}:`, tariffsToCompare.length);

                if (tariffsToCompare.length === 0) {
                    console.error(`No hay tarifas cargadas para ${tariffType}`);
                    return window.showErrorModal(`Las tarifas ${tariffType} no est√°n cargadas. Por favor, espere un momento e intente de nuevo.`);
                }

                const results = tariffsToCompare.map(t => calculateTariffCost(t, data, tariffType));
                console.log('Results calculated:', results.length);
                
                let bestOverall = null;
                let bestDrk = null;

                results.forEach(r => {
                    // Siempre comparamos por el coste anual
                    const annualCost = r.totalAnnual;
                    
                    // Best overall is the one with the lowest annual cost
                    if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                        bestOverall = r;
                    }

                    // Best DRK is the DRK one with the lowest annual cost
                    if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                        if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                        }
                    }
                });

                if (!bestOverall) {
                    console.error('No se encontr√≥ ning√∫n resultado v√°lido');
                    return window.showErrorModal("Sin resultados v√°lidos. Aseg√∫rate de que las tarifas est√°n cargadas.");
                }
                
                console.log('Best overall:', bestOverall.offer.name, bestOverall.totalAnnual);
                console.log('Best DRK:', bestDrk ? bestDrk.offer.name : 'None', bestDrk ? bestDrk.totalAnnual : 0);
                
                // --- GUARDAR OFERTAS CON AHORRO POSITIVO ---
                availableOffers = results.filter(r => {
                    r.savings = r.originalBillAnnual - r.totalAnnual;
                    const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                    
                    // Si modo es "DRK √öNICAMENTE", filtrar solo ofertas DRK
                    if (comparisonMode === 'drk_only') {
                        return hasPositiveSavings && r.offer.isDrk;
                    }
                    
                    // En otros modos, mostrar todas las ofertas con ahorro
                    return hasPositiveSavings;
                });
                console.log('Available offers with savings (filtered by mode):', availableOffers.length);
                console.log('Comparison mode:', comparisonMode);
                
                let final = bestOverall;
                let brand = activeBrand;

                // --- L√ìGICA DE SELECCI√ìN Y BRANDING (Individual) ---
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    final = bestOverall;
                    
                    // Aplicar branding seg√∫n qui√©n gan√≥
                    if (final.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        final = bestDrk || bestOverall;
                        // DRK √öNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        final = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si gan√≥ una comercializadora NO-DRK
                        if (final.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
                
                console.log('Final selection:', final.offer.name, 'Brand:', brand.NAME);
                
                // Recalcular el ahorro basado en el resultado final seleccionado
                final.savings = final.originalBillAnnual - final.totalAnnual;
                
                // Manejar casos sin ahorro
                if (final.savings <= 0) {
                    final.isNegativeSavings = true;
                    final.savings = 0;
                    final.totalAnnual = final.originalBillAnnual;
                    final.offer = { 
                        name: "Tu Tarifa Actual", 
                        description: "Es la mejor opci√≥n detectada", 
                        isDrk: false 
                    };
                    // Mantener el branding seg√∫n el modo seleccionado
                    brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
                }
                // Add originalTariffType for consistent logic in HTML generation
                final.originalTariffType = tariffType;

                lastComparisonResult = final;
                
                console.log('About to apply brand styles. Brand:', brand.NAME);
                try {
                    applyBrandStyles(brand);
                    console.log('Brand styles applied successfully');
                } catch (styleError) {
                    console.error('Error in applyBrandStyles:', styleError);
                    throw styleError;
                }
                
                // Guardar el resultado temporalmente
                lastComparisonResult = final;
                lastComparisonResult.isMulti = false;
                
                console.log('Checking available offers...');
                console.log('availableOffers.length:', availableOffers.length);
                console.log('final.savings:', final.savings);
                console.log('currentTariffType:', currentTariffType);
                
                // NUEVA L√ìGICA: Si hay ofertas con ahorro, mostrar modal de decisi√≥n
                // PERO SOLO en modo individual, NO en MultiCups
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';
                
                if (!isMultiCupsMode && availableOffers.length > 1) {
                    console.log('Showing decision modal with', availableOffers.length, 'offers');
                    showOfferDecisionModal();
                    return; // No mostrar resultados todav√≠a, esperar decisi√≥n del usuario
                }
                
                // Si es MultiCups, solo hay 1 oferta, o ninguna, mostrar resultados directamente
                console.log('About to render UI...');
                renderResultsUI(final);
                
                console.log('Showing results view...');
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                
                console.log('compareOffers completed successfully');
            } catch (error) {
                console.error('Error in compareOffers:', error);
                window.showErrorModal(`Error al calcular: ${error.message}. Por favor, intente de nuevo.`);
            }
        }


        // --- L√ìGICA MULTICUPS ---

        /**
         * Nueva vista intermedia para seleccionar 2.0TD o 3.0TD en modo MultiCups.
         */
        function showMultiCupsSagaView() {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.remove('hidden');
            document.getElementById('app-subtitle').textContent = TARIFF_CONFIG.MULTICUPS.label;
            
            // Mostrar secci√≥n de tipo de selecci√≥n de oferta

            updateMultiCupsSagaView();
        }
        
        /**
         * Actualiza el contador y el bot√≥n de finalizar en la vista SAGA.
         */
        function updateMultiCupsSagaView() {
            const totalCount = multiCupsData.length;
            document.getElementById('saga-total-cups').textContent = totalCount;
            document.getElementById('saga-finalize-count').textContent = totalCount;
            
            const finalizeBtn = document.getElementById('multicups-finalize-btn-saga');
            if (totalCount > 0) {
                finalizeBtn.classList.remove('hidden');
            } else {
                finalizeBtn.classList.add('hidden');
            }

            // Habilitar botones si las tarifas est√°n cargadas
            const loadingEl = document.getElementById('loading-status-saga');
            const isReady = currentTariffs['2.0TD'].length > 0 && currentTariffs['3.0TD'].length > 0;
            const sagaButtonWrapper = document.getElementById('saga-button-wrapper');

            if (isReady) {
                loadingEl.classList.add('hidden');
                sagaButtonWrapper.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                loadingEl.classList.remove('hidden');
                sagaButtonWrapper.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        
        /**
         * Se llama al pulsar 2.0TD o 3.0TD en la vista SAGA.
         * @param {string} type - '2.0TD' or '3.0TD'
         */
        window.selectMultiCupType = (type) => {
            multiCupsAddType = type;
            
            // 1. Ocultar Saga, Mostrar Vista de entrada
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('initial-view').classList.remove('hidden');
            
            // 2. Configurar el bot√≥n de volver
            document.getElementById('back-button-label').textContent = "a MultiCups";
            
            // 3. Configurar Vista de entrada
            const qrButtonsContainer = document.getElementById('qr-buttons-container');
            const manualInputBtn = document.getElementById('manual-input-btn');
            const currentTariffLabel = document.getElementById('current-tariff-label');
            const scanInstructionText = document.getElementById('scan-instruction-text');

            currentTariffLabel.textContent = `MULTICUPS (${type})`;
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length; // Keep existing count

            if (type === '2.0TD') {
                // 2.0TD: QR and Manual
                qrButtonsContainer.classList.remove('hidden');
                manualInputBtn.classList.add('mt-3');
                scanInstructionText.textContent = "Escanea el c√≥digo QR (2.0TD) o introduce datos manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            } else if (type === '3.0TD') {
                // 3.0TD: ONLY Manual
                qrButtonsContainer.classList.add('hidden');
                manualInputBtn.classList.remove('mt-3');
                scanInstructionText.textContent = "Introduce los datos de la factura 3.0TD manualmente.";
                document.getElementById('scan-instruction-text').classList.remove('hidden'); // Ensure instruction is visible
            }
            
            manualInputBtn.textContent = "A√ëADIR SUMINISTRO MANUAL";
            // Asegurarse de aplicar los estilos correctos al bot√≥n manual
            applyBrandStyles(activeBrand);  
            // Ocultar status de carga, ya que ya est√°n cargadas desde la vista SAGA
            document.getElementById('loading-status').classList.add('hidden');
        }

        function finalizeMultiCups() {
            if (multiCupsData.length === 0) return window.showErrorModal("A√±ada al menos un suministro.");

            compareMultiOffers();
        }

        function compareMultiOffers() {
            if (multiCupsData.length === 0) return window.showErrorModal("No hay suministros para comparar.");
            
            // 1. Acumular Totales y Consumos
            const total = multiCupsData.reduce((acc, current) => {
                // current.totalAnnual ya contiene el costo de la tarifa "ganadora" (que puede ser la actual si no hay ahorro)
                const newAnnual = current.totalAnnual;  
                
                acc.originalBillAnnual += current.originalBillAnnual;
                acc.totalAnnual += newAnnual;
                acc.totalPeriod += current.importe_total; // Sumamos el total del periodo original

                // Acumulaci√≥n de Potencias y Energ√≠as (para el desglose detallado)
                const type = current.originalTariffType;
                
                // General Power Accumulation (P1-P6) - Accumulate the CONTRACTED power (not the calculated cost)
                for (let i = 1; i <= 6; i++) {
                    const kwKey = `potencia_p${i}_kw`;
                    if (current[kwKey] !== undefined) {
                        // Usamos solo '2.0TD' o '3.0TD' como claves de grupo
                        const groupKey = (type === '2.0TD' ? '2.0TD' : '3.0TD');
                        
                        if (TARIFF_CONFIG[type]?.powerPeriods >= i || type === '3.0TD') {
                            acc.aggregatedData[groupKey].power[`p${i}`] += current[kwKey] || 0;
                        }
                    }
                }

                // General Energy Accumulation (E1-E6)
                // Use consumption names based on the type, but store generically
                if (type === '2.0TD') {
                    acc.aggregatedData[type].energy.e1 += current.consumo_punta || 0;
                    acc.aggregatedData[type].energy.e2 += current.consumo_llano || 0;
                    acc.aggregatedData[type].energy.e3 += current.consumo_valle || 0;
                } else if (type === '3.0TD') {
                    for (let i = 1; i <= 6; i++) {
                        // For 3.0TD, fields are named consumo_p1 to consumo_p6
                        acc.aggregatedData['3.0TD'].energy[`e${i}`] += current[`consumo_p${i}`] || 0;
                    }
                }
                
                return acc;
            }, {
                originalBillAnnual: 0,
                totalAnnual: 0,
                totalPeriod: 0,
                diasFacturados: 0, // Not accurately summable/averagable, kept as 0/N/A for summary
                aggregatedData: {
                    '2.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } },
                    '3.0TD': { power: { p1: 0, p2: 0, p3: 0, p4: 0, p5: 0, p6: 0 }, energy: { e1: 0, e2: 0, e3: 0, e4: 0, e5: 0, e6: 0 } }
                }
            });

            // 2. Calcular Ahorro Final Consolidado
            total.savings = total.originalBillAnnual - total.totalAnnual;

            // 3. Determinar la Oferta de Referencia para el resumen
            let bestOverallWinner = multiCupsData.reduce((best, current) => {
                // If this item has more savings, it becomes the reference.
                if (current.savings > best.savings) return { savings: current.savings, offer: current.offer, originalTariffType: current.originalTariffType };
                return best;
            }, { 
                savings: -1, 
                offer: { name: 'Resultado Consolidado', description: 'N/A', isDrk: false },
                originalTariffType: 'N/A'
            });

            if (total.savings <= 0) {
                bestOverallWinner.offer = { name: "Tu Tarifa Actual", description: "Es la mejor opci√≥n consolidada", isDrk: false };
                total.savings = 0; // Ensure consistency
            } else {
                // Ahorro positivo: Usar un nombre gen√©rico para la cabecera
                const genericName = activeBrand.NAME.includes('DRK') ? 'DRK Energ√≠a' : 'POWER CUP';
                const genericDescription = `Ofrece el mayor ahorro consolidado con ${genericName}.`;

                bestOverallWinner.offer = { 
                    name: genericName, 
                    description: genericDescription, 
                    // Se usa la bandera isDrk basada en el modo de comparaci√≥n para el styling/branding
                    isDrk: activeBrand.NAME.includes('DRK') 
                };
            }

            const finalResult = {
                cups: `${multiCupsData.length} CUPS`, // String for display
                multiCupsList: multiCupsData.map(d => `${d.cups} (${d.originalTariffType})`).join(', '),
                dias_facturados: total.diasFacturados, // Should remain N/A or 0 for multi-cups
                importe_total: total.totalPeriod,
                originalBillAnnual: total.originalBillAnnual,
                totalAnnual: total.totalAnnual,
                savings: total.savings,
                offer: bestOverallWinner.offer, // Use the (potentially generic) offer for the header display
                isMulti: true,
                individualResults: multiCupsData, // A√±adir resultados individuales para el desglose HTML
                aggregatedData: total.aggregatedData
            };
            
            lastComparisonResult = finalResult;
            
            // --- L√ìGICA DE BRANDING (MultiCups) ---
            let brandToApply = activeBrand;
            
            if (comparisonMode === 'overall_best') {
                // REQUERIMIENTO DEL USUARIO: Si es modo Power Cup Global, siempre usa Power Cup.
                brandToApply = BRANDS.POWER_CUP;
            } else {
                // DRK modes (drk_only, drk_prioritized)
                if (finalResult.savings <= 0) {
                    // No savings, stick to the initial DRK brand
                    brandToApply = BRANDS.DRK;
                } else if (bestOverallWinner.offer.isDrk) {
                    // DRK won overall combo -> Use DRK brand
                    brandToApply = BRANDS.DRK;
                } else {
                    // Competitor won overall combo in a DRK mode -> Use Power Cup (general market/non-DRK saving)
                    brandToApply = BRANDS.POWER_CUP;
                }
            }
            
            applyBrandStyles(brandToApply);
            
            renderMultiResultsUI(finalResult);
            
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('multicups-saga-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            document.getElementById('results-view').classList.add('animate-fade-in-up');
        }


        /**
         * Rellena la vista de resultados con los datos acumulados para MULTICUPS.
         * @param {Object} res - Resultado final de la comparaci√≥n acumulada.
         */
        function renderMultiResultsUI(res) {
            const offer = res.offer;
            let brand = activeBrand; // Use activeBrand set by comparisonMode
            const individualResults = res.individualResults;
            const aggregatedData = res.aggregatedData;
            const isDrk = brand.NAME.includes('DRK');
            
            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa din√°mico para MultiCups
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-6 md:p-8 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            ${brand.LOGO_SVG}
                            <div>
                                <h1 class="text-white text-3xl md:text-4xl font-black tracking-tight">DRK ENERG√çA</h1>
                                <p class="text-drk-100 text-sm md:text-base font-medium">Liderando el ahorro y la eficiencia energ√©tica.</p>
                            </div>
                        </div>
                        <div class="hidden md:block text-right">
                            <p class="text-drk-200 text-xs font-bold uppercase tracking-wider">Estudio de Ahorro</p>
                            <p class="text-white text-lg font-black">COMPARATIVA PROFESIONAL</p>
                        </div>
                    </div>
                `;
            } else {
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-white via-powercup-50 to-white p-6 md:p-8 border-2 border-powercup-500 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            ${brand.LOGO_SVG}
                            <div>
                                <h1 class="text-powercup-900 text-3xl md:text-4xl font-black tracking-tight">POWER CUP</h1>
                                <p class="text-powercup-700 text-sm md:text-base font-semibold">Asesor√≠a Energ√©tica</p>
                            </div>
                        </div>
                        <div class="hidden md:block text-right">
                            <p class="text-powercup-600 text-xs font-bold uppercase tracking-wider">Estudio de Ahorro</p>
                            <p class="text-powercup-900 text-lg font-black">COMPARATIVA PROFESIONAL</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen Global
            document.getElementById('results-cups-list').innerHTML = `
                CUPS Procesadas: ${individualResults.length}
            `;

            // MODIFICACI√ìN: Mostrar Nombre y Descripci√≥n.
            // Si el nombre es gen√©rico ("Tu Mejor Elecci√≥n"), solo mostramos el nombre en H2 y la descripci√≥n en el p√°rrafo.
            if (res.isMulti && res.savings > 0 && offer.name !== "Tu Tarifa Actual") {
                document.getElementById('best-offer-name').textContent = offer.name;
                document.getElementById('best-offer-desc').textContent = offer.description;
            } else {
                // Opci√≥n 'Tu Tarifa Actual' o individual (mantiene el formato combinado)
                document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
                document.getElementById('best-offer-desc').textContent = offer.description;
            }
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color din√°micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.savings <= 0) {
                savingsEl.textContent = "0,00 ‚Ç¨";
                // A√±adir clase de color seg√∫n el brand
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                newCostLabelEl.textContent = "TU COSTE ACTUAL CONSOLIDADO";
                oldCostPeriodEl.classList.remove('line-through'); // Remove red line-through
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through'); // Remove red line-through
                oldCostAnnualEl.classList.add('text-cta-green-500');
            } else {
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                newCostLabelEl.textContent = `TU NUEVO COSTE ${brand.NAME.includes('DRK') ? 'DRK' : 'POWER CUP'} CONSOLIDADO`;
                oldCostPeriodEl.classList.add('line-through', 'text-red-400', 'decoration-red-400/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + "/a√±o";
            document.getElementById('old-period-days-label').textContent = `Total Periodo (Variado)`; // D√≠as var√≠an por factura
            
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + "/mes";
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + "/a√±o";
            
            
            // 2. Nuevo: Resumen de Suministros (Tipo, CUPS, Ahorro Individual)
            let summaryListHTML = individualResults.map((resItem, index) => {
                // MODIFICACI√ìN #2: Eliminar "Sin Ahorro" en la vista interna, dejando un espacio.
                const savingsText = resItem.isNegativeSavings ? `&nbsp;` : `(Ahorro: ${eur(resItem.savings)})`;
                return `<div class="flex justify-between items-center py-1 border-b border-slate-100 last:border-b-0">
                    <span class="font-bold text-sm text-slate-700">${resItem.cups}</span>
                    <span class="text-xs text-drk-800 font-semibold">${resItem.originalTariffType}</span>
                    <span class="text-xs ${resItem.isNegativeSavings ? 'text-slate-500' : 'text-cta-green-600 font-medium'}">${savingsText}</span>
                </div>`;
            }).join('');

            const supplySummarySection = `
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3 mb-3" style="border-left-color: ${brand.QR_CENTER_BG};">Resumen de Suministros A√±adidos</h3>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6 space-y-1">
                    ${summaryListHTML}
                </div>
            `;


            // 3. Datos Acumulados Agrupados por Tarifa
            let totalEnergy = 0;
            Object.keys(aggregatedData).forEach(type => {
                // Solo iteramos 2.0TD y 3.0TD, ya que 6.1TD ya no existe en el estado global
                Object.values(aggregatedData[type].energy).forEach(kwh => {
                    totalEnergy += kwh;
                });
            });
            
            // Helper para generar el HTML del grupo
            function generateGroupedDataHTML(type, data, powerPeriods, energyPeriods) {
                const is20TD = type === '2.0TD';
                
                const hasPower = Object.values(data.power).slice(0, powerPeriods).some(v => v > 0);
                const hasEnergy = Object.values(data.energy).slice(0, energyPeriods).some(v => v > 0);
                
                if (!hasPower && !hasEnergy) return '';  

                let energyRows = '';
                let totalGroupEnergy = 0;
                for (let i = 1; i <= energyPeriods; i++) {
                    const kwh = data.energy[`e${i}`] || 0;
                    if (kwh > 0) {
                        let label = `E${i}`;
                        if (is20TD) {
                            if (i === 1) label += ' (Punta)';
                            if (i === 2) label += ' (Llano)';
                            if (i === 3) label += ' (Valle)';
                        }
                        energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label} (Acumulado)</span><span class="font-mono">${num(kwh, 0)} kWh</span></div>`;
                        totalGroupEnergy += kwh;
                    }
                }

                let powerRows = '';
                for (let i = 1; i <= powerPeriods; i++) {
                    const kw = data.power[`p${i}`] || 0;
                    if (kw > 0) {
                        powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${i} (Acumulado)</span><span class="font-mono">${num(kw, 2)} kW</span></div>`;
                    }
                }

                // Eliminamos la referencia a 6.1 TD en el t√≠tulo, ya que el tipo 3.0TD ahora lo engloba todo
                const title = is20TD ? '2.0 TD (Hogar/Negocio)' : '3.0 TD (Industria/Gran Consumo)';

                return `
                    <div class="border-t pt-4 mt-4 first:border-t-0 first:pt-0 first:mt-0">
                        <p class="font-black text-base ${brand.PRIMARY_TEXT} mb-3">${title}</p>
                        
                        <p class="font-bold text-slate-700 mt-2 mb-1">Consumos (kWh)</p>
                        ${energyRows || '<p class="text-xs text-slate-400">No hay consumos para este tipo.</p>'}
                        ${totalGroupEnergy > 0 ? `<div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1 border-slate-200"><span>Total Consumo ${type}</span><span>${num(totalGroupEnergy, 0)} kWh</span></div>` : ''}
                        
                        <p class="font-bold text-slate-700 mt-4 mb-1">Potencias (kW)</p>
                        ${powerRows || '<p class="text-xs text-slate-400">No hay potencias para este tipo.</p>'}
                    </div>
                `;
            }

            let accumulatedSectionsHTML = '';
            accumulatedSectionsHTML += generateGroupedDataHTML('2.0TD', aggregatedData['2.0TD'], 2, 3);  
            accumulatedSectionsHTML += generateGroupedDataHTML('3.0TD', aggregatedData['3.0TD'], 6, 6);  

            const correctedConsumptionHTML = `
                <div class="grid grid-cols-1 gap-4">
                    <div class="col-span-1 border-b pb-2 mb-2">
                        <div class="flex justify-between items-center ${brand.PRIMARY_TEXT}">
                            <span class="text-sm font-black uppercase">TOTAL ENERG√çA</span>
                            <span class="text-xl font-black">${num(totalEnergy, 0)} kWh</span>
                        </div>
                    </div>
                    ${accumulatedSectionsHTML}
                </div>
            `;

            // --- 4. Precios de la Oferta Consolidada (Dynamic Winner) ---
            const { winningOffers, hasDrkWinner } = getWinningOffersPerType(individualResults);
            let tariffPricesHTML = '';
            const consolidatedPrices = [];
            const brandPrimaryText = brand.PRIMARY_TEXT;
            const isPowerCupMode = comparisonMode === 'overall_best';

            // Determine the label for the price section
            const priceSectionLabel = (isPowerCupMode && !hasDrkWinner) 
                ? 'Precios de la Oferta Ganadora Consolidada (POWER CUP GLOBAL)' 
                : 'Precios de la Oferta Consolidada';

            const basePrefix = brand.NAME.includes('DRK') ? 'drk' : 'powercup';
            const color800 = brand.PRIMARY_TEXT.replace('text-', ''); // Get dynamic color: text-drk-800 -> drk-800

            // Add 2.0TD Prices - TODAS las ofertas √∫nicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`;
                    
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</h5>
                            <div class="grid grid-cols-2 gap-x-4 text-xs">
                                <p class="text-slate-500">P1 (‚Ç¨/kW/d√≠a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p1)}</p>
                                <p class="text-slate-500">P2 (‚Ç¨/kW/d√≠a):</p><p class="font-mono font-bold text-right">${numPriceFormula(p2)}</p>
                                <p class="text-slate-500 mt-2 col-span-2 font-bold text-cta-green-600">ENERG√çA (‚Ç¨/kWh)</p>
                                <p class="text-slate-500">E1 (Punta):</p><p class="font-mono font-bold text-right">${numPriceFormula(e1)}</p>
                                <p class="text-slate-500">E2 (Llano):</p><p class="font-mono font-bold text-right">${numPriceFormula(e2)}</p>
                                <p class="text-slate-500">E3 (Valle):</p><p class="font-mono font-bold text-right">${numPriceFormula(e3)}</p>
                            </div>
                        </div>
                    `);
                });
            }

            // Add 3.0TD Prices - TODAS las ofertas √∫nicas
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<p class="text-slate-500">P${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</p>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<p class="text-slate-500">E${i}:</p><p class="font-mono font-bold text-right">${numPriceFormula(offer30[`p${i}_price`])}</p>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    consolidatedPrices.push(`
                        <div class="mb-4 p-3 bg-white rounded-lg border border-${basePrefix}-100">
                            <h5 class="font-black text-sm text-${color800} border-b pb-1 mb-2">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-red-500 mb-1">POTENCIA (‚Ç¨/kW/d√≠a)</div>
                                ${pRows}
                                <div class="col-span-2 md:col-span-4 font-bold text-cta-green-600 mt-2 mb-1 border-t pt-2">ENERG√çA (‚Ç¨/kWh)</div>
                                ${eRows}
                            </div>
                        </div>
                    `);
                });
            }

            if (consolidatedPrices.length > 0) {
                tariffPricesHTML = `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                        <h4 class="font-bold text-lg ${brandPrimaryText} mb-3">${priceSectionLabel}</h4>
                        ${consolidatedPrices.join('')}
                        <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de las ofertas ganadoras detectadas para cada tipo de tarifa y se aplican a las CUPS a√±adidas.</p>
                    </div>
                `;
            }

            // 5. Desglose detallado de CADA CUPS (Se mantiene)

            let allBreakdownsHTML = '';

            individualResults.forEach((resItem, index) => {
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                // MODIFICACI√ìN: Usar Comercializadora - Tarifa para ofertas DRK.
                const appliedOfferName = resItem.offer.isDrk 
                    ? `${resItem.offer.name} - ${resItem.offer.description}` 
                    : resItem.offer.name;

                let energyBreakdown = '';
                resItem.energyCosts.forEach(e => {
                    let label = `E${e.period}`;
                    if (resItem.originalTariffType === '2.0TD') {
                        if (e.period === 1) label += ' (Punta)';
                        if (e.period === 2) label += ' (Llano)';
                        if (e.period === 3) label += ' (Valle)';
                    }
                    
                    if (e.period <= periods) {
                        energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)</span><span>${num(e.cost, 2)} ‚Ç¨</span></div>`;
                    }
                });

                let powerBreakdown = '';
                resItem.powerCosts.forEach(p => {
                    if (p.period <= powerPeriods) {
                        powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/d√≠a)</span><span>${num(p.cost, 2)} ‚Ç¨</span></div>`;
                    }
                });
                
                const statusText = resItem.isNegativeSavings ? 
                    `<p class="text-sm font-bold text-cta-red-600 mb-2">‚ö†Ô∏è TU TARIFA ACTUAL es la mejor</p>` :
                    `<p class="text-sm font-bold text-cta-green-600 mb-2">üí∞ AHORRO ANUAL: ${eur(resItem.savings)}</p>`;

                allBreakdownsHTML += `
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-lg text-sm">
                               <h4 class="text-lg font-black text-slate-800 border-b pb-2 mb-3">Suministro ${index + 1}: ${resItem.cups} (${resItem.originalTariffType})</h4>
                               ${statusText}
                               <p class="text-xs text-slate-500 mb-3">Tarifa aplicada en el c√°lculo: <span class="font-bold text-slate-700">${appliedOfferName}</span></p>
                               <div class="grid grid-cols-2 gap-4 border-b border-slate-200 pb-3 mb-3">
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">Factura Actual Periodo</p>
                                       <p class="font-bold text-cta-red-500">${eur(resItem.importe_total)}</p>
                                   </div>
                                   <div class="text-center">
                                       <p class="text-slate-400 text-xs uppercase">Nuevo Coste Periodo</p>
                                       <p class="font-black ${brand.PRIMARY_TEXT}">${eur(resItem.totalPeriod)}</p>
                                   </div>
                               </div>

                               <p class="font-bold text-slate-800 mb-2">Desglose (${appliedOfferName}):</p>
                               
                               <div class="pl-2 space-y-2 font-mono text-xs">
                                   <p class="font-bold text-slate-700">POTENCIA</p>
                                   ${powerBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>Subtotal Potencia</span><span>${num(resItem.subPower, 2)} ‚Ç¨</span></div>
                                   
                                   <p class="font-bold text-slate-700 pt-2">ENERG√çA</p>
                                   ${energyBreakdown}
                                   <div class="flex justify-between font-bold text-slate-800 border-t pt-1"><span>Subtotal Energ√≠a (Neto)</span><span>${num(resItem.subEnergyNet, 2)} ‚Ç¨</span></div>
                                   
                                   <div class="flex justify-between font-black ${brand.PRIMARY_TEXT} pt-2"><span>TOTAL CON IMPUESTOS</span><span>${eur(resItem.totalPeriod)}</span></div>
                               </div>
                    </div>
                `;
            });


            const detailsContainer = document.getElementById('details-container');

            detailsContainer.innerHTML = `
                ${supplySummarySection}
                <h3 id="extracted-data-header" class="text-lg font-bold text-slate-800 border-l-4 ${brand.BORDER.replace('border-', 'border-')} pl-3">Datos Acumulados</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">${correctedConsumptionHTML}</div>
                
                ${tariffPricesHTML}
                
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3" style="border-left-color: ${brand.QR_CENTER_BG};">Desglose Individual por Suministro</h3>
                <p class="text-sm text-slate-500 mb-4 pl-3">A continuaci√≥n, se muestra el c√°lculo detallado de la mejor oferta para cada CUPS, por orden de introducci√≥n:</p>
                <div id="cost-breakdown-multi" class="space-y-4">
                    ${allBreakdownsHTML}
                </div>
            `;
        }
        
        /**
         * Rellena la vista de resultados con los datos calculados (UNIDAD).
         * @param {Object} res - Resultado final de la comparaci√≥n.
         */
        function renderResultsUI(res) {
            try {
                console.log('renderResultsUI called with:', res);
                
                const offer = res.offer;
                const brand = activeBrand;
                const isDrk = brand.NAME.includes('DRK');
                const tariffType = res.tariffType || currentTariffType;
                // Usamos TARIFF_CONFIG[tariffType] y si no existe (ej: 6.1TD residual), se usa un fallback seguro, aunque ya hemos limpiado el estado
                const config = TARIFF_CONFIG[tariffType] || TARIFF_CONFIG['2.0TD']; 

                console.log('Rendering with tariffType:', tariffType, 'Brand:', brand.NAME);

            // FIX: Usar funciones robustas contra NaN
            const eur = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            // NUEVO: Generar banner de empresa din√°mico
            const companyBanner = document.getElementById('company-banner');
            if (isDrk) {
                // Banner DRK - Estilo elegante azul
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-drk-900 via-drk-800 to-drk-700 p-6 md:p-8 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            ${brand.LOGO_SVG}
                            <div>
                                <h1 class="text-white text-3xl md:text-4xl font-black tracking-tight">DRK ENERG√çA</h1>
                                <p class="text-drk-100 text-sm md:text-base font-medium">Liderando el ahorro y la eficiencia energ√©tica.</p>
                            </div>
                        </div>
                        <div class="hidden md:block text-right">
                            <p class="text-drk-200 text-xs font-bold uppercase tracking-wider">Estudio de Ahorro</p>
                            <p class="text-white text-lg font-black">COMPARATIVA PROFESIONAL</p>
                        </div>
                    </div>
                `;
            } else {
                // Banner POWER CUP - Estilo energ√©tico verde
                companyBanner.innerHTML = `
                    <div class="bg-gradient-to-r from-white via-powercup-50 to-white p-6 md:p-8 border-2 border-powercup-500 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            ${brand.LOGO_SVG}
                            <div>
                                <h1 class="text-powercup-900 text-3xl md:text-4xl font-black tracking-tight">POWER CUP</h1>
                                <p class="text-powercup-700 text-sm md:text-base font-semibold">Asesor√≠a Energ√©tica</p>
                            </div>
                        </div>
                        <div class="hidden md:block text-right">
                            <p class="text-powercup-600 text-xs font-bold uppercase tracking-wider">Estudio de Ahorro</p>
                            <p class="text-powercup-900 text-lg font-black">COMPARATIVA PROFESIONAL</p>
                        </div>
                    </div>
                `;
            }
            
            // 1. Cabecera y Resumen
            document.getElementById('results-cups-list').innerHTML = `
                CUPS: <span class="font-mono text-slate-700" id="cups-value">${res.cups}</span>
            `;
            
            // MODIFICACI√ìN: Mostrar Comercializadora - Tarifa
            document.getElementById('best-offer-name').textContent = `${offer.name || ''}`;
            document.getElementById('best-offer-desc').textContent = offer.description;
            
            const savingsEl = document.getElementById('savings-estimate');
            const newCostLabelEl = document.getElementById('new-cost-label');
            const oldCostPeriodEl = document.getElementById('old-period-cost-display');
            const oldCostAnnualEl = document.getElementById('old-annual-cost-display');

            // Resetear clases de color din√°micas
            savingsEl.className = 'text-5xl font-black tracking-tight';
            oldCostPeriodEl.classList.remove('line-through', 'text-red-400', 'text-cta-green-500', 'decoration-red-400/50');
            oldCostAnnualEl.classList.remove('line-through', 'text-cta-red-500', 'text-cta-green-500', 'decoration-cta-red-500/50');

            if (res.isNegativeSavings) {
                savingsEl.textContent = "0,00 ‚Ç¨";
                // A√±adir clase de color seg√∫n el brand (extraer solo la clase de color)
                const colorClass = brand.PRIMARY_TEXT.replace('text-', '');
                savingsEl.classList.add('text-' + colorClass);
                
                newCostLabelEl.textContent = "TU COSTE ACTUAL";
                
                // Si no hay ahorro, el coste actual es el "bueno", sin tachar
                oldCostPeriodEl.classList.remove('line-through'); // Remove red line-through
                oldCostPeriodEl.classList.add('text-cta-green-500');
                oldCostAnnualEl.classList.remove('line-through'); // Remove red line-through
                oldCostAnnualEl.classList.add('text-cta-green-500');

            } else {
                savingsEl.textContent = eur(res.savings);
                savingsEl.classList.add('text-cta-green-500');
                
                newCostLabelEl.textContent = `TU NUEVO COSTE ${isDrk ? 'DRK' : 'POWER CUP'}`;
                
                // Tachar el coste antiguo
                oldCostPeriodEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
                oldCostAnnualEl.classList.add('line-through', 'text-cta-red-500', 'decoration-cta-red-500/50');
            }
            
            document.getElementById('old-period-cost-display').textContent = eur(res.importe_total);
            document.getElementById('old-annual-cost-display').textContent = eur(res.originalBillAnnual) + "/a√±o";
            document.getElementById('old-period-days-label').textContent = `Total Periodo (${res.dias_facturados} d√≠as)`;
            
            document.getElementById('new-monthly-cost-display').textContent = eur(res.totalAnnual / 12) + "/mes";
            document.getElementById('new-annual-cost-display').textContent = eur(res.totalAnnual) + "/a√±o";
            
            // 2. Desglose (Datos Extra√≠dos)
            let energyRows = '';
            res.energyCosts.forEach(e => {
                let label = `E${e.period}`;
                if (tariffType === '2.0TD') {
                    if (e.period === 1) label += ' (Punta)';
                    if (e.period === 2) label += ' (Llano)';
                    if (e.period === 3) label += ' (Valle)';
                }
                if(e.kwh > 0 || e.period <= config.periods) {
                    energyRows += `<div class="flex justify-between text-xs mb-1"><span>${label}</span><span class="font-mono">${num(e.kwh, 0)} kWh</span></div>`;
                }
            });
            const totalEnergy = res.energyCosts.reduce((sum, e) => sum + e.kwh, 0);

            let powerRows = '';
            res.powerCosts.forEach(p => {
                if(p.kw > 0 || p.period <= config.powerPeriods) {
                    powerRows += `<div class="flex justify-between text-xs mb-1"><span>P${p.period}</span><span class="font-mono">${num(p.kw, 2)} kW</span></div>`;
                }
            });

            const consumptionHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-xs text-slate-500">Periodo</p><p class="font-bold text-slate-700">${res.dias_facturados} d√≠as</p></div>
                    <div><p class="text-xs text-slate-500">Fechas</p><p class="font-bold text-slate-700 text-xs">${res.fechas}</p></div>
                    <div class="col-span-2 border-t pt-2 mt-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">Consumo por Periodo (kWh)</p>
                        ${energyRows}
                        <div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1"><span>Total Consumo</span><span>${num(totalEnergy, 0)} kWh</span></div>  
                    </div>
                    <div class="col-span-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">Potencia Contratada (kW)</p>
                        ${powerRows}
                    </div>
                </div>
            `;

            // 3. Desglose (C√°lculo Oficial)
            let powerBreakdown = '';
            res.powerCosts.forEach(p => {
                if (p.kw > 0 || p.period <= config.powerPeriods) {
                    powerBreakdown += `<div class="flex justify-between"><span>P${p.period} (${num(p.kw, 2)} kW x ${numPriceFormula(p.priceDay)} ‚Ç¨/d√≠a)</span><span>${num(p.cost, 2)} ‚Ç¨</span></div>`;
                }
                });
                
            let energyBreakdown = '';
            res.energyCosts.forEach(e => {
                if (e.kwh > 0 || e.period <= config.periods) {
                    let label = `E${e.period}`;
                    if (tariffType === '2.0TD') {
                        if (e.period === 1) label += ' (Punta)';
                        if (e.period === 2) label += ' (Llano)';
                        if (e.period === 3) label += ' (Valle)';
                    }
                    energyBreakdown += `<div class="flex justify-between"><span>${label} (${num(e.kwh, 0)} kWh x ${numPriceFormula(e.price)} ‚Ç¨/kWh)</span><span>${num(e.cost, 2)} ‚Ç¨</span></div>`;
                }
                });

            let discountRowsHtml = res.discountAmount > 0 ? `
                <div class="flex justify-between font-bold text-cta-red-500 mt-2">
                    <span>Descuento Aplicado (${num(res.discountRate * 100, 0)}%)</span>
                    <span>-${num(res.discountAmount, 2)} ‚Ç¨</span>
                </div>
                <div class="flex justify-between font-bold text-slate-800 border-t border-dashed mt-1 pt-1">
                    <span>Subtotal Energ√≠a (Neto)</span>
                    <span>${num(res.subEnergyNet, 2)} ‚Ç¨</span>
                </div>
            ` : '';

            const breakdownHTML = `
                <div class="bg-white p-6 font-mono text-xs md:text-sm text-slate-600 leading-relaxed">
                    <div class="text-center border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                        <h4 class="font-bold text-lg text-slate-800 uppercase">${offer.name}</h4>
                        <p>Simulaci√≥n ${res.dias_facturados} d√≠as</p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">POTENCIA (‚Ç¨/kW D√≠a)</p>
                        ${powerBreakdown}
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>Subtotal Potencia</span><span>${num(res.subPower, 2)} ‚Ç¨</span></div>
                    </div>

                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">ENERG√çA (‚Ç¨/kWh)</p>
                        ${energyBreakdown}
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>Subtotal Energ√≠a (Bruto)</span><span>${num(res.subEnergy, 2)} ‚Ç¨</span></div>
                        ${discountRowsHtml}
                    </div>

                    <div class="border-t border-slate-200 pt-2 mb-2">
                        <div class="flex justify-between font-bold text-slate-800"><span>SUBTOTAL BASE (P+E)</span><span>${num(res.subBase, 2)} ‚Ç¨</span></div>
                        <div class="flex justify-between"><span>Imp. El√©c. (${num(res.ieRate * 100, 3)}%)</span><span>${num(res.costIE, 2)} ‚Ç¨</span></div>
                        <div class="flex justify-between font-bold text-lg border-t mt-1 pt-1"><span>BASE IMPONIBLE</span><span>${num(res.baseImp, 2)} ‚Ç¨</span></div>
                        <div class="flex justify-between"><span>IVA (21%)</span><span>${num(res.costIVA, 2)} ‚Ç¨</span></div>
                    </div>
                    
                    <div class="bg-drk-900 text-white p-3 rounded-lg flex justify-between items-center text-md font-bold mb-1 mt-4"><span>TOTAL FACTURA</span><span>${eur(res.totalPeriod)}</span></div>
                    <div class="text-center mt-2 ${brand.PRIMARY_TEXT} font-bold">Total Anual Estimado: ${eur(res.totalAnnual)}</div>
                </div>
            `;
            
            // NUEVO: Generar resumen de precios consolidados
            let preciosHTML = '';
            if (offer.name !== 'Tu Tarifa Actual') {
                const nombreCompleto = offer.isDrk ? `${offer.name} - ${offer.description}` : offer.name;
                
                if (tariffType === '2.0TD') {
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">Precios de la Oferta Consolidada</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">Tarifa 2.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 gap-x-4 text-xs">
                                    <p class="text-slate-500">P1 (‚Ç¨/kW/d√≠a):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[0].priceDay)}</p>
                                    <p class="text-slate-500">P2 (‚Ç¨/kW/d√≠a):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[1].priceDay)}</p>
                                    <p class="text-slate-500 mt-2 col-span-2 font-bold text-green-600">ENERG√çA (‚Ç¨/kWh)</p>
                                    <p class="text-slate-500">E1 (Punta):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[0].price)}</p>
                                    <p class="text-slate-500">E2 (Llano):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[1].price)}</p>
                                    <p class="text-slate-500">E3 (Valle):</p>
                                    <p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[2].price)}</p>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de la oferta ganadora.</p>
                        </div>
                    `;
                } else if (tariffType === '3.0TD') {
                    let filasPotencia = '';
                    for(let i = 0; i < 6; i++) {
                        filasPotencia += `<p class="text-slate-500">P${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.powerCosts[i].priceDay)}</p>`;
                    }
                    let filasEnergia = '';
                    for(let i = 0; i < 6; i++) {
                        filasEnergia += `<p class="text-slate-500">E${i+1}:</p><p class="font-mono font-bold text-right">${numPriceFormula(res.energyCosts[i].price)}</p>`;
                    }
                    
                    preciosHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm text-sm mb-6">
                            <h4 class="font-bold text-lg text-slate-800 mb-3">Precios de la Oferta Consolidada</h4>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <h5 class="font-black text-sm text-slate-700 border-b pb-1 mb-2">Tarifa 3.0 TD - ${nombreCompleto}</h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 text-xs">
                                    <div class="col-span-2 md:col-span-4 font-bold text-red-500 mb-1">POTENCIA (‚Ç¨/kW/d√≠a)</div>
                                    ${filasPotencia}
                                    <div class="col-span-2 md:col-span-4 font-bold text-green-600 mt-2 mb-1 border-t pt-2">ENERG√çA (‚Ç¨/kWh)</div>
                                    ${filasEnergia}
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">*Los precios mostrados son de la oferta ganadora.</p>
                        </div>
                    `;
                }
            }
            
            const detailsContainer = document.getElementById('details-container');

            detailsContainer.innerHTML = `
                <h3 id="extracted-data-header" class="text-lg font-bold text-slate-800 border-l-4 ${brand.BORDER.replace('border-', 'border-')} pl-3">Datos Extra√≠dos</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm">${consumptionHTML}</div>
                ${preciosHTML}
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3" style="border-left-color: ${brand.QR_CENTER_BG};">C√°lculo Oficial</h3>
                <div id="cost-breakdown" class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm">
                    ${breakdownHTML}
                </div>
            `;
            
            console.log('renderResultsUI completed successfully');
            } catch (error) {
                console.error('Error in renderResultsUI:', error);
                window.showErrorModal(`Error al mostrar resultados: ${error.message}`);
            }
        }
        
        // --- COPIA HTML MEJORADA ---

        async function handleCopyOffer() {
            if (!lastComparisonResult) return window.showErrorModal("Primero realice una comparaci√≥n.");
            
            const commercialCode = document.getElementById('comercial-code-input').value.trim();
            if (!commercialCode) return window.showErrorModal("Indique el C√≥digo Comercial.");

            try {
                // 1. Generar el HTML
                let htmlContent = '';
                if (lastComparisonResult.isMulti) {
                    htmlContent = generateMultiStyledHtmlOffer(commercialCode);
                } else {
                    htmlContent = generateStyledHtmlOffer(commercialCode);
                }
                
                // 2. Crear un elemento temporal para la copia HTML enriquecida
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                // Seleccionar y copiar
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);

                if (success) {
                    window.showMessageModal("‚úÖ ¬°Oferta copiada con √©xito! Ahora puede pegar (Ctrl+V o Cmd+V) el dise√±o visual en su correo de escritorio.");
                    document.getElementById('send-offer-modal').classList.add('hidden');
                    document.getElementById('send-offer-modal').classList.remove('flex');
                } else {
                    window.showErrorModal("No se pudo copiar el dise√±o visual. Intente desde un PC o contacte a soporte.");
                }
            } catch (e) {
                console.error("Error al copiar al portapapeles:", e);
                window.showErrorModal(`Error de Portapapeles: ${e.message}`);
            }
        }
        
        function generateStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult;
            const offer = bd.offer;
            const brand = activeBrand;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Dynamic Branding Setup ---
            // If activeBrand is POWER_CUP (comparisonMode === 'overall_best')
            const D_PRIMARY_DARK = brand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = brand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = brand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = brand.NAME;
            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const BG_LIGHT = brand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TEL√âFONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';
            
            const p1PricePerDay = bd.powerCosts.find(p => p.period === 1)?.priceDay || 0;
            const p2PricePerDay = bd.powerCosts.find(p => p.period === 2)?.priceDay || 0;
            const e1Price = bd.energyCosts.find(e => e.period === 1)?.price || 0;
            const e2Price = bd.energyCosts.find(e => e.period === 2)?.price || 0;
            const e3Price = bd.energyCosts.find(e => e.period === 3)?.price || 0;

            const monthlyEstimate = eur(bd.totalAnnual / 12);
            const totalConsumption = num(bd.energyCosts.reduce((sum, e) => sum + e.kwh, 0), 0) + ' kWh';
            
            const LB = '%0A';
            const discountLine = bd.discountRate > 0 ? `Descuento: ${num(bd.discountRate * 100, 0)}% aplicado a Energ√≠a.${LB}` : '';

            // MODIFICACI√ìN: Nombre completo de la tarifa
            const commercialTariffName = bd.isNegativeSavings ? "Tu Tarifa Actual" : (offer.isDrk ? `${offer.name} - ${offer.description}` : offer.name);
            const commercializadoraName = offer.isDrk ? offer.name?.toUpperCase() : (offer.name?.toUpperCase() === 'TU TARIFA ACTUAL' ? 'TU COMERCIALIZADORA' : offer.name?.toUpperCase());

            const emailBody = `‚úÖ CONFIRMACI√ìN DE ACEPTACI√ìN DE OFERTA${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaci√≥n de la oferta energ√©tica que detallo a continuaci√≥n:${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìã DATOS DEL SUMINISTRO${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üîå CUPS:${LB}${bd.cups}${LB}${LB}` +
                                 `‚ö° TARIFA CONTRATADA:${LB}${commercialTariffName}${LB}${LB}` +
                                 `üåç Zona Geogr√°fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `üìä Consumo Facturado: ${totalConsumption}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí∞ BENEFICIO ECON√ìMICO${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üíµ Ahorro Anual Estimado: ${eur(bd.savings)}${LB}` +
                                 `üìÖ Coste Mensual Estimado: ${monthlyEstimate}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí° PRECIOS CONTRATADOS${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üî¥ POTENCIA:${LB}` +
                                 `   ‚Ä¢ P1: ${numPriceFormula(p1PricePerDay)} ‚Ç¨/kW/d√≠a${LB}` +
                                 `   ‚Ä¢ P2: ${numPriceFormula(p2PricePerDay)} ‚Ç¨/kW/d√≠a${LB}${LB}` +
                                 `üü¢ ENERG√çA:${LB}` +
                                 `   ‚Ä¢ E1 (Punta): ${numPriceFormula(e1Price)} ‚Ç¨/kWh${LB}` +
                                 `   ‚Ä¢ E2 (Llano): ${numPriceFormula(e2Price)} ‚Ç¨/kWh${LB}` +
                                 `   ‚Ä¢ E3 (Valle): ${numPriceFormula(e3Price)} ‚Ç¨/kWh${LB}${LB}` +
                                 `${discountLine}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üë§ DATOS DEL TITULAR${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üìõ Nombre completo: ${clientName}${LB}` +
                                 `üì± Tel√©fono: ${clientPhone}${LB}` +
                                 `üìß Email: ${clientEmail}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìé DOCUMENTACI√ìN ADJUNTA${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Adjunto la siguiente documentaci√≥n para formalizar el contrato:${LB}${LB}` +
                                 `‚úì 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `‚úì 2. √öltima factura de luz (m√≠n. 3 meses)${LB}` +
                                 `‚úì 3. Email de contacto${LB}` +
                                 `‚úì 4. Tel√©fono de contacto${LB}` +
                                 `‚úì 5. N√∫mero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí¨ COMENTARIOS ADICIONALES${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `[Escriba aqu√≠ cualquier observaci√≥n o consulta adicional]${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Quedo a la espera de la confirmaci√≥n de la formalizaci√≥n del contrato.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `‚úÖ FORMALIZACI√ìN CONTRATO - CUPS: ${bd.cups}`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const rowLabel = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #555; vertical-align: top;`;
            const rowValue = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; color: #333; text-align: right; white-space: nowrap; vertical-align: top;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;
            const GREEN_SAVE_COLOR = '#16a34a';
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;

            // --- PLANTILLA PARA AHORRO NEGATIVO ---
            if (bd.isNegativeSavings) {
                const isDrkBrand = brand.NAME.includes('DRK');
                const companyBanner = isDrkBrand ? `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERG√çA</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                ` : `
                    <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                        <tr>
                            <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                                <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                                <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">Asesor√≠a Energ√©tica</p>
                            </td>
                            <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                                <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                                <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                            </td>
                        </tr>
                    </table>
                `;
                
                return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                        <tr><td colspan="2" style="${headerCell}">
                            <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                            <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">TU TARIFA ACTUAL ES LA M√ÅS COMPETITIVA</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 15px;">
                            <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>CUPS:</strong> ${bd.cups}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                        </td></tr>
                        <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 25px 20px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                            <div style="font-size: 60px; color: ${GREEN_SAVE_COLOR}; margin-bottom: 10px; line-height: 1;">&#9989;</div>
                            <p style="margin: 0; color: ${D_PRIMARY_DARK}; font-size: 22px; font-weight: bold;">¬°Excelente Noticia!</p>
                            <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 18px; font-weight: normal;">TU TARIFA ACTUAL ES LA M√ÅS COMPETITIVA DEL MERCADO</h2>
                            <p style="margin: 0; font-size: 14px; color: #555;">En este momento, no existe una oferta que mejore tu coste actual. Seguiremos estudiando.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 20px; text-align: center;">
                            <p style="font-size: 14px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-bottom: 5px;">COSTE ANUAL ESTIMADO (ACTUAL):</p>
                            <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block;">${eur(bd.originalBillAnnual)}</span>
                            <p style="font-size: 12px; color: #888;">/ A√ëO (basado en el consumo de ${bd.dias_facturados} d√≠as)</p>
                            <p style="margin-top: 15px; font-size: 14px; color: #555;">[Colaborador: ${commercialCode}] | Este resumen es una simulaci√≥n.</p>
                        </td></tr>
                        <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                    </table>`;
            }

            // --- PLANTILLA EST√ÅNDAR (Ahorro Positivo) ---
            
            const currentTariffConfig = TARIFF_CONFIG[bd.tariffType];
            
            // Desglose: Potencia
            let desglosePotencia = bd.powerCosts.map(p => {
                if (p.period <= currentTariffConfig.powerPeriods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P${p.period} (${num(p.kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(p.cost, 2)} ‚Ç¨</td></tr>`;
                }
                return '';
            }).join('');
            
            // Desglose: Energ√≠a
            let desgloseEnergia = bd.energyCosts.map(e => {
                if (e.period <= currentTariffConfig.periods) {
                    return `<tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E${e.period} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(e.cost, 2)} ‚Ç¨</td></tr>`;
                }
                return '';
            }).join('');
            
            const discountRowsHtml = bd.discountAmount > 0 ? `
                <tr><td style="${rowLabel} font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(bd.discountRate * 100, 0)}%)</td><td style="${rowValue} font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(bd.discountAmount, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL ENERG√çA (Neto)</td><td style="${rowValue} background-color: #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subEnergyNet, 2)} ‚Ç¨</td></tr>
            ` : '';
            
            const desgloseRows = `
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 5px 0 2px 0;">T√âRMINO POTENCIA (Precio en ‚Ç¨/kW D√≠a)</div></td></tr>
                ${desglosePotencia}
                <tr><td style="${rowLabel} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL POTENCIA</td><td style="${rowValue} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subPower, 2)} ‚Ç¨</td></tr>
                
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 10px 0 2px 0;">T√âRMINO ENERG√çA (Precios en ‚Ç¨/kWh)</div></td></tr>
                ${desgloseEnergia}
                <tr><td style="${rowLabel} border-bottom: 2px solid #333; font-weight: bold; color: #555;">Subtotal Energ√≠a (Bruto)</td><td style="${rowValue} border-bottom: 2px solid #333; font-weight: bold; color: #555; white-space: nowrap;">${num(bd.subEnergy, 2)} ‚Ç¨</td></tr>
                
                ${discountRowsHtml}
                
                <tr><td style="${rowLabel} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL BASE (P+E)</td><td style="${rowValue} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subBase, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel}">Imp. El√©c. (${num(bd.ieRate * 100, 3)}%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIE, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel} font-weight: bold;">BASE IMPONIBLE</td><td style="${rowValue} font-weight: bold; white-space: nowrap;">${num(bd.baseImp, 2)} ‚Ç¨</td></tr>
                <tr><td style="${rowLabel}">IVA (21%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIVA, 2)} ‚Ç¨</td></tr>
                
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL FACTURA (${bd.dias_facturados} D√çAS)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalPeriod)}</td></tr>
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL A√ëO (PROYECTADO)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalAnnual)}</td></tr>
            `;

            const discountSummaryRow = bd.discountRate > 0 ? `
                <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #CC0000;">DESCUENTO ENERG√çA</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap; color: #CC0000;">${num(bd.discountRate * 100, 0)}%</td></tr>
            ` : '';
            
            const preciosResumenTable = `
                <tr><td colspan="2" style="padding-top: 20px;"><div style="${sectionTitle}">RESUMEN DE PRECIOS DE LA OFERTA √öNICA</div></td></tr>
                <tr><td colspan="2" style="padding: 0;">
                    <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 12px; table-layout: fixed;">
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 5px 8px; text-align: left; color: ${D_PRIMARY_DARK}; width: 60%;">CONCEPTO</th>
                            <th style="padding: 5px 8px; text-align: right; color: ${D_PRIMARY_DARK}; width: 40%;">PRECIO ${commercializadoraName}</th>
                        </tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P1 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p1PricePerDay)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P2 (‚Ç¨/kW/d√≠a)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(p2PricePerDay)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E1 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e1Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E2 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e2Price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energ√≠a E3 (‚Ç¨/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(e3Price)}</td></tr>
                        ${discountSummaryRow}
                        <tr style="background-color: #eee; font-weight: bold;"><td style="padding: 8px; color: ${D_PRIMARY_DARK};">AHORRO ANUAL</td><td style="padding: 8px; text-align: right; font-size: 14px; color: ${GREEN_SAVE_COLOR}; white-space: nowrap;">${eur(bd.savings)}</td></tr>
                        <tr style="background-color: white; height: 10px;"><td colspan="2"></td></tr>
                    </table>
                </td></tr>
            `;

            const finalSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">RESUMEN DE AHORRO FINAL</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE_COLOR}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">/ A√ëO</p>
                    </div>
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email
            const isDrkBrand = brand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERG√çA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">Asesor√≠a Energ√©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - ${D_BRAND_NAME.toUpperCase()}</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>CUPS:</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 15px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                        <p style="margin: 0; color: ${D_PRIMARY_MED}; font-size: 12px; font-weight: bold; letter-spacing: 1px;">LA MEJOR OPCI√ìN PARA TI ES</p>
                        <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 22px;">${commercialTariffName}</h2>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">¬°CONSIGUE TU AHORRO ANUAL!</p>
                        </div>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">TU FACTURA ACTUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">/ A√ëO</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">TU NUEVO COSTE ${commercializadoraName}</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">/ A√ëO</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} / MES</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    
                    ${preciosResumenTable}
                    
                    <tr><td colspan="2"><div style="${sectionTitle}">DESGLOSE DETALLADO DE LA SIMULACI√ìN (${commercialTariffName})</div></td></tr>
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px; margin-bottom: 20px; table-layout: fixed;">
                            ${desgloseRows}
                        </table>
                    </td></tr>
                    
                    ${finalSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">üìß Para confirmar esta oferta:</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. Haz clic en el bot√≥n de abajo<br>
                                2. Se abrir√° tu cliente de email<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">Adjunta la documentaci√≥n requerida</strong><br>
                                4. Env√≠a el email
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">‚úÖ CONFIRMAR Y ENVIAR</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                üìÑ <strong>Documentaci√≥n necesaria:</strong><br>
                                DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | Este resumen es una simulaci√≥n basada en su √∫ltima factura.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }


        function generateMultiStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult; // Resultado acumulado
            const offer = bd.offer;
            const individualResults = bd.individualResults;
            
            // FIX: Usar funciones robustas contra NaN
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n || 0);
            
            const DRK_DARK = '#0c4a6e'; const DRK_MED = '#075985'; const DRK_CTA = '#0284c7';
            const PC_DARK = '#3f6212'; const PC_MED = '#65a30d'; const PC_CTA = '#84cc16';

            // --- Determine Dynamic Branding for Email Copy ---
            const { winningOffers } = getWinningOffersPerType(individualResults);

            let dynamicBrand = activeBrand; // Use the current active brand (set by comparison mode)
            
            const D_PRIMARY_DARK = dynamicBrand.NAME.includes('DRK') ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = dynamicBrand.NAME.includes('DRK') ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = dynamicBrand.NAME.includes('DRK') ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = dynamicBrand.NAME;
            const BG_LIGHT = dynamicBrand.NAME.includes('DRK') ? '#f0f9ff' : '#f7fee7';  

            const ZONA_GEOGRAFICA = "PENINSULA"; // HARDCODED AS REQUESTED

            const RED_CTA = '#CC0000';
            const GREEN_SAVE = '#16a34a';
            
            // --- Shared Section Title Style (Removed margin-top: 10px) ---
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px;`;


            const clientName = document.getElementById('client-name-input').value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = document.getElementById('client-phone-input').value.trim() || '[TEL√âFONO CLIENTE]';
            const clientEmail = document.getElementById('client-email-input').value.trim() || '[EMAIL CLIENTE]';

            // Generar tabla de desglose individual
            let individualBreakdowns = '';
            individualResults.forEach((resItem, index) => {
                // La l√≥gica de cu√°l es la mejor oferta ya se ha aplicado en saveSupply
                const isBest = resItem.isNegativeSavings === false;  
                const currentConfig = TARIFF_CONFIG[resItem.originalTariffType] || TARIFF_CONFIG['2.0TD'];
                const periods = currentConfig.periods;
                const powerPeriods = currentConfig.powerPeriods;
                
                // Determinar el nombre de la tarifa final aplicada
                const appliedOfferName = resItem.offer.isDrk  
                    ? `${resItem.offer.name} - ${resItem.offer.description}` 
                    : resItem.offer.name;

                // Desglose: Potencia
                let desglosePotencia = resItem.powerCosts.map(p => {
                    if (p.period <= powerPeriods) {
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">P${p.period} (${num(p.kw,2)} kW x ${resItem.dias_facturados}d x ${numPriceFormula(p.priceDay)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(p.cost, 2)} ‚Ç¨</td></tr>`;
                    }
                    return '';
                }).join('');

                // Desglose: Energ√≠a
                let desgloseEnergia = resItem.energyCosts.map(e => {
                    if (e.period <= periods) {
                        let label = `E${e.period}`;
                        if (resItem.originalTariffType === '2.0TD') {
                            if (e.period === 1) label += ' (Punta)';
                            if (e.period === 2) label += ' (Llano)';
                            if (e.period === 3) label += ' (Valle)';
                            }
                        return `<tr><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; color: #555;">${label} (${num(e.kwh,0)} kWh x ${numPriceFormula(e.price)})</td><td style="padding: 5px 8px; font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: right; white-space: nowrap;">${num(e.cost, 2)} ‚Ç¨</td></tr>`;
                    }
                    return '';
                }).join('');
                
                const discountRowsHtml = resItem.discountAmount > 0 ? `
                    <tr><td style="padding: 5px 8px; font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(resItem.discountRate * 100, 0)}%)</td><td style="padding: 5px 8px; text-align: right; font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(resItem.discountAmount, 2)} ‚Ç¨</td></tr>
                    ` : '';

                // MODIFICACI√ìN #2: Ajuste para eliminar "Sin Ahorro" en el email copy si no hay ahorro, dejando solo el total.
                const ahorroAnualText = isBest
                    ? `. Ahorro Anual: <span style="color: ${GREEN_SAVE}; font-weight: bold;">${eur(resItem.savings)}</span>`
                    : '';

                individualBreakdowns += `
                    <tr><td colspan="2" style="padding: 15px 20px 0 20px; background-color: #f8fafc; border-top: 2px solid #ddd;">
                        <h4 style="margin: 0 0 10px 0; font-size: 16px; color: ${D_PRIMARY_DARK}; font-weight: bold;">[${index + 1}] CUPS: ${resItem.cups} (${resItem.originalTariffType})</h4>
                        <p style="margin: 0 0 5px 0; font-size: 12px; color: #555;">Tarifa Aplicada: <span style="font-weight: bold;">${appliedOfferName}</span></p>
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #555;">D√≠as Facturados: ${resItem.dias_facturados}${ahorroAnualText}</p>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" style="table-layout: fixed; margin-bottom: 10px; background-color: white; border: 1px solid #eee;">
                            <tr style="background-color: #f5f5f5;">
                                <th colspan="2" style="padding: 5px 8px; text-align: left; font-size: 12px; color: ${D_PRIMARY_MED}; border-bottom: 1px solid #ddd;">SIMULACI√ìN DE COSTES POR PERIODO</th>
                            </tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">POTENCIA</td></tr>
                            ${desglosePotencia}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td colspan="2" style="padding: 5px 8px; font-weight: bold; color: ${D_PRIMARY_MED};">ENERG√çA</td></tr>
                            ${desgloseEnergia}
                            ${discountRowsHtml}
                            <tr><td colspan="2" style="height: 5px;"></td></tr>
                            <tr><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK};">TOTAL FACTURA (PERIODO)</td><td style="padding: 8px; background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK}; text-align: right;">${eur(resItem.totalPeriod)}</td></tr>
                        </table>
                    </td></tr>
                `;
            });
            
            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;

            // URL para formalizaci√≥n
            const LB = '%0A';
            
            // MODIFICACI√ìN: Nombre completo de la oferta consolidada
            const consolidatedTariffName = `${offer.name} - ${offer.description}`;

            const emailBody = `‚úÖ CONFIRMACI√ìN OFERTA CONSOLIDADA - MULTICUPS${LB}${LB}` +
                                 `Estimado equipo de ${D_BRAND_NAME.toUpperCase()},${LB}${LB}` +
                                 `Confirmo mi aceptaci√≥n de la oferta energ√©tica consolidada para m√∫ltiples suministros:${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìä RESUMEN CONSOLIDADO${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `‚ö° OFERTA:${LB}${consolidatedTariffName}${LB}${LB}` +
                                 `üåç Zona Geogr√°fica: ${ZONA_GEOGRAFICA}${LB}` +
                                 `üîå Total Suministros: ${individualResults.length} CUPS${LB}${LB}` +
                                 `üìã CUPS INCLUIDOS:${LB}${bd.multiCupsList}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí∞ BENEFICIO ECON√ìMICO TOTAL${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üíµ Ahorro Anual Consolidado: ${eur(bd.savings)}${LB}` +
                                 `üìÖ Coste Mensual Total: ${eur(bd.totalAnnual / 12)}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üë§ DATOS DEL TITULAR${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `üìõ Nombre completo: ${clientName}${LB}` +
                                 `üì± Tel√©fono: ${clientPhone}${LB}` +
                                 `üìß Email: ${clientEmail}${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üìé DOCUMENTACI√ìN POR CUPS${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Adjunto la siguiente documentaci√≥n para cada CUPS:${LB}${LB}` +
                                 `‚úì 1. Foto DNI/CIF (anverso y reverso)${LB}` +
                                 `‚úì 2. √öltima factura de cada suministro (m√≠n. 3 meses)${LB}` +
                                 `‚úì 3. Email de contacto${LB}` +
                                 `‚úì 4. Tel√©fono de contacto${LB}` +
                                 `‚úì 5. N√∫mero de cuenta bancaria (IBAN)${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}` +
                                 `üí¨ COMENTARIOS ADICIONALES${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `[Escriba aqu√≠ cualquier observaci√≥n o consulta adicional]${LB}${LB}` +
                                 `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${LB}${LB}` +
                                 `Quedo a la espera de la confirmaci√≥n de la formalizaci√≥n del contrato consolidado.${LB}${LB}` +
                                 `Atentamente,${LB}` +
                                 `${clientName}`;

            const subject = `‚úÖ FORMALIZACI√ìN CONSOLIDADA - ${individualResults.length} CUPS`;
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es';  
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;

            // --- Precios de la Oferta Consolidada (Dynamic Winner) ---
            
            let preciosConsolidadosHTML = '';
            const priceSectionHeader = dynamicBrand.NAME.includes('DRK')
                ? 'PRECIOS DE LA OFERTA CONSOLIDADA (DRK ENERG√çA)'
                : 'PRECIOS DE LA OFERTA GANADORA CONSOLIDADA (POWER CUP GLOBAL)';

            // 2.0TD Prices - TODAS las ofertas √∫nicas
            const offers20 = winningOffers['2.0TD'];
            const has20TD = individualResults.some(d => d.originalTariffType === '2.0TD');
            if (offers20 && offers20.length > 0 && has20TD) {
                offers20.forEach((offer20, index) => {
                    const fullTariffName20 = `${offer20.name || 'Tarifa 2.0TD'} - ${offer20.description || 'N/A'}`; 
                    const p1 = offer20.p_potencia_1 / 365;
                    const p2 = offer20.p_potencia_2 / 365;
                    const e1 = offer20.p1_price;
                    const e2 = offer20.p2_price;
                    const e3 = offer20.p3_price;
                    
                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 2.0 TD #${index + 1} - ${fullTariffName20}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td style="padding: 2px 0; width: 60%; color: #555;">P1 (‚Ç¨/kW/d√≠a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p1)}</td></tr>
                                <tr><td style="padding: 2px 0; color: #555;">P2 (‚Ç¨/kW/d√≠a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(p2)}</td></tr>
                                <tr style="height: 5px;"><td colspan="2"></td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERG√çA E1 (Punta - ‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e1)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERG√çA E2 (Llano - ‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e2)}</td></tr>
                                <tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">ENERG√çA E3 (Valle - ‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(e3)}</td></tr>
                            </table>
                        </div>
                    `;
                });
            }

            // 3.0TD Prices - TODAS las ofertas √∫nicas  
            const offers30 = winningOffers['3.0TD'];
            const has30TD = individualResults.some(d => d.originalTariffType === '3.0TD');
            if (offers30 && offers30.length > 0 && has30TD) {
                offers30.forEach((offer30, index) => {
                    let pRows = '';
                    for(let i=1; i<=6; i++) {
                        pRows += `<tr><td style="padding: 2px 0; color: #555;">P${i} (‚Ç¨/kW/d√≠a):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: #333;">${numPriceFormula(offer30[`p_potencia_${i}`] / 365)}</td></tr>`;
                    }
                    let eRows = '';
                    for(let i=1; i<=6; i++) {
                        eRows += `<tr><td style="padding: 2px 0; font-weight: bold; color: ${GREEN_SAVE};">E${i} (‚Ç¨/kWh):</td><td style="text-align: right; font-weight: bold; font-family: monospace; color: ${GREEN_SAVE};">${numPriceFormula(offer30[`p${i}_price`])}</p></td></tr>`;
                    }
                    const fullTariffName30 = `${offer30.name || 'Tarifa 3.0TD'} - ${offer30.description || 'N/A'}`;

                    preciosConsolidadosHTML += `
                        <div style="margin-top: 15px; padding: 10px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 13px; color: ${D_PRIMARY_DARK};">Tarifa 3.0 TD #${index + 1} - ${fullTariffName30}</p>
                            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 11px; table-layout: fixed;">
                                <tr><td colspan="2" style="font-weight: bold; color: ${RED_CTA}; padding: 5px 0 2px 0;">POTENCIA</td></tr>
                                ${pRows}
                                <tr><td colspan="2" style="font-weight: bold; color: ${GREEN_SAVE}; padding: 5px 0 2px 0; border-top: 1px dashed #ccc; margin-top: 5px;">ENERG√çA</td></tr>
                                ${eRows}
                            </table>
                        </div>
                    `;
                });
            }
            
            const preciosResumenSection = preciosConsolidadosHTML ? `
                <tr><td colspan="2" style="padding: 20px 20px 0 20px;"><div style="${sectionTitle}">${priceSectionHeader}</div></td></tr>
                <tr><td colspan="2" style="padding: 0 20px 20px 20px;">
                    ${preciosConsolidadosHTML}
                </td></tr>
            ` : '';
            
            // FIX 2: NUEVO RESUMEN DE AHORRO CONSOLIDADO justo antes del bot√≥n
            const finalMultiSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">AHORRO TOTAL CONSOLIDADO</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                        <p style="font-size: 12px; color: #888;">/ A√ëO</p>
                    </div>
                </td></tr>
            `;

            // NUEVO: Banner de empresa para email MultiCups
            const isDrkBrand = dynamicBrand.NAME.includes('DRK');
            const companyBanner = isDrkBrand ? `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #075985; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #ffffff; font-size: 28px; font-weight: bold; line-height: 1.2;">DRK ENERG√çA</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #bae6fd; font-size: 13px; line-height: 1.3;">Liderando el ahorro y la eficiencia energ√©tica.</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #e0f2fe; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #ffffff; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            ` : `
                <table cellpadding="0" cellspacing="0" width="600" style="width: 600px; max-width: 100%; margin: 0 auto 20px auto; border-collapse: collapse; background-color: #ffffff; border: 2px solid #84cc16; font-family: Arial, sans-serif;">
                    <tr>
                        <td style="padding: 20px 20px 20px 20px; vertical-align: middle; width: 60%;">
                            <p style="margin: 0; padding: 0; color: #365314; font-size: 28px; font-weight: bold; line-height: 1.2;">POWER CUP</p>
                            <p style="margin: 5px 0 0 0; padding: 0; color: #4d7c0f; font-size: 13px; font-weight: bold; line-height: 1.3;">Asesor√≠a Energ√©tica</p>
                        </td>
                        <td style="padding: 20px 20px 20px 10px; text-align: right; vertical-align: middle; width: 40%;">
                            <p style="margin: 0; padding: 0; color: #65a30d; font-size: 9px; font-weight: bold; text-transform: uppercase;">ESTUDIO DE AHORRO</p>
                            <p style="margin: 3px 0 0 0; padding: 0; color: #365314; font-size: 14px; font-weight: bold;">COMPARATIVA PROFESIONAL</p>
                        </td>
                    </tr>
                </table>
            `;

            return companyBanner + `<table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO CONSOLIDADO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">AN√ÅLISIS DE ${individualResults.length} SUMINISTROS (2.0TD + 3.0TD)</p>
                    </td></tr>
                    
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>TOTAL CUPS:</strong> ${individualResults.length}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>OFERTA CONSOLIDADA:</strong> ${consolidatedTariffName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">AHORRO ANUAL CONSOLIDADO:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">¬°AHORRO TOTAL PARA ${individualResults.length} SUMINISTROS!</p>
                        </div>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">COSTE ACTUAL ANUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">/ A√ëO</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">NUEVO COSTE ${D_BRAND_NAME.toUpperCase()} ANUAL</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">/ A√ëO</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} / MES</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    
                    ${preciosResumenSection}
                    
                    <tr><td colspan="2"><div style="background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px; margin-top: 10px;">DESGLOSE INDIVIDUAL DE AHORRO</div></td></tr>
                    ${individualBreakdowns}
                    
                    ${finalMultiSavingsSummary}

                    <tr><td colspan="2" style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                        <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; border: 2px solid ${D_PRIMARY_MED};">
                            <p style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold; color: ${D_PRIMARY_DARK};">üìä Para formalizar esta oferta consolidada:</p>
                            <p style="margin: 0 0 15px 0; font-size: 13px; color: #555; line-height: 1.6;">
                                1. Haz clic en el bot√≥n de abajo<br>
                                2. Se abrir√° tu cliente de email<br>
                                3. <strong style="color: ${D_PRIMARY_DARK};">Adjunta documentaci√≥n de los ${individualResults.length} CUPS</strong><br>
                                4. Env√≠a el email
                            </p>
                            <a href="${formalizationLink}" style="${btnStyle}">‚úÖ CONFIRMAR OFERTA CONSOLIDADA</a>
                            <p style="margin: 15px 0 0 0; font-size: 11px; color: #666; line-height: 1.5;">
                                üìÑ <strong>Por cada CUPS adjuntar:</strong><br>
                                DNI/CIF ¬∑ √öltima factura ¬∑ Email ¬∑ Tel√©fono ¬∑ IBAN
                            </p>
                        </div>
                        <p style="font-size: 10px; color: #999; margin-top: 15px;">[Colaborador: ${commercialCode}] | Este resumen es una simulaci√≥n consolidada de ${individualResults.length} suministros.</p>
                    </td></tr>

                    <tr><td colspan="2" style="padding: 0; height: 5px;"><div style="${footerStyle}"></div></td></tr>
                </table>`;
        }

        // --- MANEJO DE INPUTS MANUALES ---

        function handleManualInput() {
            try {
                console.log('handleManualInput called');
                console.log('currentTariffType:', currentTariffType);
                console.log('comparisonMode:', comparisonMode);
                
                const isMultiCupsMode = currentTariffType === 'MULTICUPS';

                // Usar multiCupsAddType o currentTariffType para el c√°lculo
                const tariffToUse = isMultiCupsMode ? multiCupsAddType : currentTariffType;
                console.log('tariffToUse:', tariffToUse);
                
                if (!tariffToUse) return window.showErrorModal("Error: Seleccione un tipo de tarifa (2.0TD o 3.0TD).");
                
                const getVal = id => parseFloat(document.getElementById(id).value.replace(',','.')) || 0;
                
                const data = {
                    cups: document.getElementById('input-cups').value || 'MANUAL',
                    dias_facturados: parseInt(document.getElementById('input-billing-days').value) || 30,
                    importe_total: getVal('input-total-bill'),
                    fechas: 'Entrada Manual',
                };

                for(let i=1; i<=6; i++) {
                    data[`potencia_p${i}_kw`] = getVal(`input-p${i}-kw`);
                    data[`consumo_p${i}`] = getVal(`input-e${i}-kwh`);
                }
                
                // Llenar consumo_punta/llano/valle para 2.0TD (basado en E1, E2, E3)
                data['consumo_punta'] = data.consumo_p1;
                data['consumo_llano'] = data.consumo_p2;
                data['consumo_valle'] = data.consumo_p3;
                
                console.log('Data prepared:', data);
                
                if (data.importe_total <= 0) return window.showErrorModal("Introduce el total de la factura.");
                
                closeManualInputModal();
                
                if (isMultiCupsMode) {
                    console.log('Saving supply for MultiCups');
                    saveSupply(data, tariffToUse);
                } else {
                    console.log('Comparing offers for single tariff');
                    compareOffers(data);
                }
            } catch (error) {
                console.error('Error in handleManualInput:', error);
                window.showErrorModal(`Error al procesar datos: ${error.message}`);
            }
        }
        
        function startManualInputFlow() {
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';
            const tariffToConfigure = isMultiCupsMode ? multiCupsAddType : currentTariffType;
            
            if (isMultiCupsMode && !tariffToConfigure) return window.showErrorModal("Error interno: Seleccione primero 2.0 TD o 3.0 TD en la pantalla anterior.");
            
            // 1. Limpiar inputs
            clearManualInputs('input');
            
            // 2. Configurar el modal para modo Individual o Multi
            const selectorWrapper = document.getElementById('manual-tariff-selector-wrapper');
            const selectEl = document.getElementById('manual-input-tariff-select');
            const modalTitleEl = document.getElementById('manual-modal-title');
            
            if (isMultiCupsMode) {
                // MODO MULTICUPS: Ocultamos el selector ya que el tipo es conocido
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = `A√±adir Suministro #${multiCupsData.length + 1} (${tariffToConfigure} Manual)`;
                document.getElementById('execute-manual-input-btn').textContent = "A√ëADIR SUMINISTRO";
                
                // Forzar la selecci√≥n del tipo de CUPS seleccionado en la vista SAGA
                // Solo si el tipo existe en el selector (2.0TD o 3.0TD)
                if (selectEl.querySelector(`option[value="${tariffToConfigure}"]`)) {
                    selectEl.value = tariffToConfigure;
                }
                toggleMultiCupsInputPeriods(tariffToConfigure, 'input');

            } else {
                // MODO INDIVIDUAL: Ocultar selector (solo se usa la tarifa seleccionada en el landing)
                selectorWrapper.classList.add('hidden');
                modalTitleEl.textContent = `Entrada de Datos Manual (${currentTariffType})`;
                document.getElementById('execute-manual-input-btn').textContent = "CALCULAR";
                toggleMultiCupsInputPeriods(currentTariffType, 'input');
            }

            // 3. Mostrar Modal
            document.getElementById('manual-input-modal').classList.remove('hidden');
            document.getElementById('manual-input-modal').classList.add('flex');
            document.getElementById('input-cups').focus();
        }

        function updateComparisonMode(newMode) {
            comparisonMode = newMode;
            let currentBrandForInput = BRANDS.DRK;
            if (newMode === 'overall_best') currentBrandForInput = BRANDS.POWER_CUP;
            // Aplicar estilos y branding a toda la app
            applyBrandStyles(currentBrandForInput);
            
            // Actualizar estilos espec√≠ficos de los selectores de modo
            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                const label = r.closest('label');
                const isSelected = r.value === newMode;
                const colorClass = r.value === 'overall_best' ? 'powercup' : 'drk';
                
                // Limpiar todas las clases de color
                label.className = 'mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2';

                if (isSelected) {
                    // Bot√≥n SELECCIONADO: fondo de color, texto blanco
                    label.classList.add(`border-${colorClass}-500`, `bg-${colorClass}-500`, 'text-white', `hover:bg-${colorClass}-600`);
                    label.querySelector('.checkmark-icon').classList.remove('hidden');
                } else {
                    // Bot√≥n NO SELECCIONADO: fondo blanco, texto de color oscuro
                    label.classList.add(`border-${colorClass}-300`, 'bg-white', `text-${colorClass}-700`, `hover:bg-${colorClass}-100`, `hover:border-${colorClass}-400`);
                    label.querySelector('.checkmark-icon').classList.add('hidden');
                }
            });
        }
        
        // --- NUEVA FUNCIONALIDAD: Tipo de Selecci√≥n de Oferta ---
        
        function updateOfferSelectionType(newType) {
            offerSelectionType = newType;
            
            // Actualizar estilos de los botones de tipo de selecci√≥n
            document.querySelectorAll('input[name="offer_selection_type"]').forEach(r => {
                const container = r.closest('.offer-type-selector').querySelector('div');
                const isSelected = r.value === newType;
                
                if (isSelected) {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-drk-500 bg-drk-500 text-white transition hover:bg-drk-600';
                } else {
                    container.className = 'flex items-start gap-3 p-4 rounded-xl border-2 border-slate-300 bg-white text-slate-700 transition hover:bg-slate-50 hover:border-drk-400';
                }
            });
        }
        
        // --- NUEVO: Modal de Decisi√≥n (Mejor vs Elegir) ---
        
        function showOfferDecisionModal() {
            document.getElementById('loading-status').classList.add('hidden');
            document.getElementById('offer-decision-modal').classList.remove('hidden');
            document.getElementById('offer-decision-modal').classList.add('flex');
        }
        
        function closeOfferDecisionModal() {
            document.getElementById('offer-decision-modal').classList.add('hidden');
            document.getElementById('offer-decision-modal').classList.remove('flex');
        }
        
        function selectBestOptionDirect() {
            // Cerrar modal de decisi√≥n
            closeOfferDecisionModal();
            
            // Usar el resultado que ya estaba calculado (lastComparisonResult)
            if (!lastComparisonResult) {
                window.showErrorModal('No hay resultado disponible');
                return;
            }
            
            // Verificar si estamos en contexto MultiCups
            if (lastComparisonResult._multiCupsContext) {
                // Contexto MultiCups: A√±adir a la lista
                addSupplyToMultiCupsList(lastComparisonResult);
            } else {
                // Contexto individual: Mostrar resultados
                renderResultsUI(lastComparisonResult);
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
            }
        }
        
        function selectFromResults() {
            // Cerrar modal de decisi√≥n
            closeOfferDecisionModal();
            
            // Mostrar modal de selecci√≥n de ofertas
            if (lastComparisonResult && availableOffers.length > 0) {
                showOfferSelectionModal(lastComparisonResult.cups);
            } else {
                window.showErrorModal('No hay ofertas disponibles para seleccionar');
            }
        }
        
        // Nueva funci√≥n para a√±adir suministro a MultiCups despu√©s de elegir
        function addSupplyToMultiCupsList(result) {
            console.log('addSupplyToMultiCupsList called with result:', result);
            console.log('Result offer:', result.offer);
            console.log('Result originalTariffType:', result.originalTariffType);
            
            // Asegurar que el originalTariffType est√© presente
            if (!result.originalTariffType && result._multiCupsContext) {
                result.originalTariffType = result._multiCupsContext.tariffType;
                console.log('Set originalTariffType from context:', result.originalTariffType);
            }
            
            // Limpiar el contexto temporal
            delete result._multiCupsContext;
            
            // A√±adir a la lista
            multiCupsData.push(result);
            console.log('multiCupsData after push:', multiCupsData);
            
            // Actualizar UI y volver a la vista SAGA
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length;
            
            window.showMessageModal(`Suministro ${result.cups} (${result.offer.name}) a√±adido. Total: ${multiCupsData.length}`, "Suministro A√±adido");
            
            document.getElementById('initial-view').classList.add('hidden');
            showMultiCupsSagaView();
        }
        
        // Funciones para el modal de selecci√≥n de ofertas
        function showOfferSelectionModal(cups) {
            // Mostrar CUPS en el modal
            document.getElementById('modal-selection-cups').textContent = cups;
            
            // Poblar lista de ofertas como radio buttons
            const container = document.getElementById('offers-radio-list');
            container.innerHTML = '';
            
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
            
            availableOffers.forEach((offer, index) => {
                const commercializer = offer.offer.isDrk ? 'DRK Energ√≠a' : (offer.offer.commercializer || 'Otra comercializadora');
                const description = offer.offer.description || '';
                
                const offerCard = document.createElement('label');
                offerCard.className = 'offer-radio-card block cursor-pointer';
                offerCard.innerHTML = `
                    <input type="radio" name="selected_offer" value="${index}" class="hidden">
                    <div class="offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50">
                        <svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-slate-400 checkmark-offer hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div class="flex-1">
                            <p class="font-bold text-base text-slate-900">${offer.offer.name}</p>
                            <p class="text-sm text-slate-600">${commercializer}${description ? ' - ' + description : ''}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-xs text-slate-500">Ahorro anual</p>
                            <p class="text-xl font-black text-green-600">${eur(offer.savings)}</p>
                        </div>
                    </div>
                `;
                container.appendChild(offerCard);
            });
            
            // A√±adir event listeners a los radio buttons
            document.querySelectorAll('input[name="selected_offer"]').forEach(radio => {
                radio.addEventListener('change', handleOfferRadioChange);
            });
            
            // Mostrar modal
            document.getElementById('offer-selection-modal').classList.remove('hidden');
            document.getElementById('offer-selection-modal').classList.add('flex');
            
            // Deshabilitar bot√≥n de confirmar inicialmente
            document.getElementById('confirm-offer-selection-btn').disabled = true;
            
            // Inicializar contadores y limpiar filtros
            document.getElementById('offers-total-count').textContent = availableOffers.length;
            document.getElementById('offers-visible-count').textContent = availableOffers.length;
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
        }
        
        // NUEVAS FUNCIONES: Filtrado y ordenaci√≥n de ofertas
        function filterAndSortOffers() {
            const searchTerm = document.getElementById('offer-search-input').value.toLowerCase();
            const sortBy = document.getElementById('offer-sort-select').value;
            
            const container = document.getElementById('offers-radio-list');
            const cards = Array.from(container.querySelectorAll('.offer-radio-card'));
            const noResultsMsg = document.getElementById('no-offers-message');
            
            let visibleCount = 0;
            
            // Aplicar filtro y crear array con datos para ordenar
            const cardData = cards.map((card, index) => {
                const offer = availableOffers[index];
                const offerName = offer.offer.name.toLowerCase();
                const commercializer = offer.offer.isDrk ? 'drk energ√≠a' : (offer.offer.commercializer || '').toLowerCase();
                const description = (offer.offer.description || '').toLowerCase();
                
                // Filtrar por b√∫squeda
                const matchesSearch = searchTerm === '' || 
                    offerName.includes(searchTerm) || 
                    commercializer.includes(searchTerm) || 
                    description.includes(searchTerm);
                
                if (matchesSearch) {
                    visibleCount++;
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
                
                return {
                    card: card,
                    offer: offer,
                    visible: matchesSearch,
                    index: index
                };
            });
            
            // Ordenar solo los visibles
            const visibleCards = cardData.filter(item => item.visible);
            visibleCards.sort((a, b) => {
                switch(sortBy) {
                    case 'savings_desc':
                        return b.offer.savings - a.offer.savings;
                    case 'savings_asc':
                        return a.offer.savings - b.offer.savings;
                    case 'name_asc':
                        return a.offer.offer.name.localeCompare(b.offer.offer.name);
                    case 'name_desc':
                        return b.offer.offer.name.localeCompare(a.offer.offer.name);
                    default:
                        return 0;
                }
            });
            
            // Reorganizar el DOM
            container.innerHTML = '';
            visibleCards.forEach(item => {
                container.appendChild(item.card);
            });
            
            // A√±adir las ocultas al final (sin mostrarlas)
            cardData.filter(item => !item.visible).forEach(item => {
                container.appendChild(item.card);
            });
            
            // Actualizar contador
            document.getElementById('offers-visible-count').textContent = visibleCount;
            
            // Mostrar/ocultar mensaje de "no hay resultados"
            if (visibleCount === 0) {
                noResultsMsg.classList.remove('hidden');
                container.classList.add('hidden');
            } else {
                noResultsMsg.classList.add('hidden');
                container.classList.remove('hidden');
            }
        }
        
        function clearOfferFilters() {
            document.getElementById('offer-search-input').value = '';
            document.getElementById('offer-sort-select').value = 'savings_desc';
            filterAndSortOffers();
        }
        
        function handleOfferRadioChange(e) {
            const selectedIndex = parseInt(e.target.value);
            manuallySelectedOffer = availableOffers[selectedIndex];
            
            // Actualizar estilos visuales
            document.querySelectorAll('.offer-radio-card').forEach((card, idx) => {
                const content = card.querySelector('.offer-card-content');
                const check = card.querySelector('.checkmark-offer');
                
                if (idx === selectedIndex) {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-drk-500 bg-drk-50 transition';
                    check.classList.remove('hidden');
                    check.classList.add('text-drk-600');
                } else {
                    content.className = 'offer-card-content flex items-start gap-4 p-4 rounded-xl border-2 border-slate-300 bg-white transition hover:border-drk-400 hover:bg-drk-50';
                    check.classList.add('hidden');
                }
            });
            
            // Habilitar bot√≥n de confirmar
            document.getElementById('confirm-offer-selection-btn').disabled = false;
        }
        
        function closeOfferSelectionModal() {
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            // NO limpiar manuallySelectedOffer aqu√≠, se limpiar√° despu√©s de usarlo
        }
        
        function confirmOfferSelection() {
            if (!manuallySelectedOffer) return;
            
            // Cerrar modal
            document.getElementById('offer-selection-modal').classList.add('hidden');
            document.getElementById('offer-selection-modal').classList.remove('flex');
            
            // Continuar con el flujo normal mostrando el resultado
            continueWithSelectedOffer();
        }
        
        function continueWithSelectedOffer() {
            console.log('continueWithSelectedOffer called');
            console.log('manuallySelectedOffer:', manuallySelectedOffer);
            console.log('lastComparisonResult:', lastComparisonResult);
            
            // Usar la oferta seleccionada manualmente
            let result = manuallySelectedOffer;
            
            if (!result) {
                console.error('No result available!');
                return;
            }
            
            console.log('Result offer:', result.offer.name);
            
            // Verificar si estamos en contexto MultiCups
            const isMultiCupsContext = lastComparisonResult && lastComparisonResult._multiCupsContext;
            
            if (isMultiCupsContext) {
                // Contexto MultiCups: Necesitamos TODOS los datos de lastComparisonResult
                // pero con la OFERTA seleccionada manualmente
                console.log('MultiCups context detected');
                
                // Crear un nuevo objeto combinando lastComparisonResult (datos base) 
                // con la oferta elegida manualmente
                const combinedResult = {
                    ...lastComparisonResult,  // Todos los datos base (CUPS, consumos, potencias, etc.)
                    offer: result.offer,      // La oferta elegida manualmente
                    totalAnnual: result.totalAnnual,  // Coste anual de la oferta elegida
                    totalPeriod: result.totalPeriod,  // Coste periodo de la oferta elegida
                    savings: result.savings,          // Ahorro de la oferta elegida
                    energyCosts: result.energyCosts,  // Desglose de energ√≠a
                    powerCosts: result.powerCosts,    // Desglose de potencia
                    subPower: result.subPower,
                    subEnergyNet: result.subEnergyNet,
                    isNegativeSavings: result.isNegativeSavings || false
                };
                
                console.log('Combined result:', combinedResult);
                
                addSupplyToMultiCupsList(combinedResult);
            } else {
                // Contexto individual: Mostrar resultados
                console.log('Individual context, showing results');
                
                // Aplicar branding
                let brand = result.offer.isDrk ? BRANDS.DRK : BRANDS.POWER_CUP;
                console.log('Applying brand:', brand.NAME);
                applyBrandStyles(brand);
                activeBrand = brand;
                
                // Asignar como resultado final
                lastComparisonResult = result;
                lastComparisonResult.isMulti = false;
                
                console.log('About to render results UI');
                // Mostrar resultados
                renderResultsUI(result);
                
                console.log('Hiding initial-view and showing results-view');
                document.getElementById('loading-status').classList.add('hidden');
                document.getElementById('initial-view').classList.add('hidden');
                document.getElementById('scanner-view').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                document.getElementById('results-view').classList.add('animate-fade-in-up');
                
                console.log('Done showing results');
            }
        }
        
        function populateOfferSelector() {
            // Esta funci√≥n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        function handleManualOfferSelection(e) {
            // Esta funci√≥n ya no se usa, pero la mantenemos por compatibilidad
        }
        
        // --- FIX: Cancelaci√≥n del Esc√°ner ---
        function cancelScanner() {
            stopScanner(); // Detiene el stream de la c√°mara
            document.getElementById('scanner-view').classList.add('hidden');
            // Vuelve a la vista de selecci√≥n de entrada (initial-view)
            document.getElementById('initial-view').classList.remove('hidden');
            document.getElementById('loading-status').classList.add('hidden');
        }

        // --- INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            // Setup Event Listeners
            document.getElementById('manual-input-btn').onclick = startManualInputFlow;
            document.getElementById('execute-manual-input-btn').onclick = handleManualInput;
            
            // FIX APLICADO: El bot√≥n de cancelar del esc√°ner ahora vuelve a la vista de input, no a resetToLanding
            document.getElementById('stop-scan-btn').onclick = cancelScanner;  
            
            document.getElementById('start-scan-btn').onclick = startScanner;
            document.getElementById('capture-photo-btn').onclick = capturePhoto;
            
            // Modificaci√≥n del bot√≥n de volver para la vista de entrada
            document.querySelector('#initial-view button:first-child').onclick = () => {
                currentTariffType === 'MULTICUPS' ? showMultiCupsSagaView() : resetToLanding();
            };
            
            document.getElementById('upload-menu-btn').onclick = () => {
                document.getElementById('qr-options-modal').classList.remove('hidden');
                document.getElementById('qr-options-modal').classList.add('flex');
            };
            
            // Bot√≥n de Finalizar MULTICUPS (en la nueva vista SAGA)
            document.getElementById('multicups-finalize-btn-saga').onclick = finalizeMultiCups;

            // Bot√≥n para subir imagen
            document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click());
            document.getElementById('image-file-input').addEventListener('change', (e) => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                if (e.target.files[0]) decodeQRFromImage(e.target.files[0]);
                e.target.value = '';
            });
            
            setupPasteCatcher(); // <-- Llamada ahora segura

            document.getElementById('send-offer-btn').onclick = () => {
                if (lastComparisonResult) {
                    document.getElementById('send-offer-modal').classList.remove('hidden');
                    document.getElementById('send-offer-modal').classList.add('flex');
                    // Aplicar focus ring de la marca a los inputs
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(activeBrand.NAME.includes('DRK') ? 'focus:ring-drk-500' : 'focus:ring-powercup-500');
                    });
                } else {
                    window.showErrorModal("Por favor, analice una factura primero para generar una oferta.");
                }
            };
            
            document.getElementById('execute-send-offer-btn').addEventListener('click', handleCopyOffer);

            document.getElementById('qr-toggle-checkbox').addEventListener('change', (e) => {
                const wrapper = document.getElementById('qr-content-wrapper');
                if (e.target.checked) {
                    generateQRCode(activeBrand);
                    wrapper.classList.add('active');
                } else {
                    wrapper.classList.remove('active');
                }
            });

            document.querySelectorAll('input[name="comparison_mode"]').forEach(r => {
                r.addEventListener('change', (e) => updateComparisonMode(e.target.value));
            });
            
            // Event listener para bot√≥n de confirmar selecci√≥n de oferta
            document.getElementById('confirm-offer-selection-btn').addEventListener('click', confirmOfferSelection);
            
            // Disparar evento de cambio inicial para aplicar el branding pre-seleccionado
            const initialModeInput = document.querySelector('input[name="comparison_mode"]:checked');
            if (initialModeInput) {
                updateComparisonMode(initialModeInput.value);
            }
        });
        
        function decodeQRFromImage(imageFileOrBlob) {
            document.getElementById('loading-status').textContent = "Procesando imagen...";
            document.getElementById('loading-status').classList.remove('hidden');
            
            const img = new Image();
            const url = URL.createObjectURL(imageFileOrBlob);
            img.onload = () => {
                URL.revokeObjectURL(url);
                const localCanvas = document.createElement('canvas');
                const ctx = localCanvas.getContext('2d');
                localCanvas.width = img.width; localCanvas.height = img.height;
                ctx.drawImage(img, 0, 0, localCanvas.width, localCanvas.height); // Usar dimensiones reales de la imagen

                try {
                    const imageData = ctx.getImageData(0, 0, localCanvas.width, localCanvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    document.getElementById('loading-status').classList.add('hidden');

                    if (code) handleQRRead(code.data);
                    else window.showErrorModal("No se pudo detectar un c√≥digo QR v√°lido en la imagen.");
                } catch (e) {
                    document.getElementById('loading-status').classList.add('hidden');
                    window.showErrorModal("Error al procesar la imagen.");
                }
            };
            img.onerror = () => {
                URL.revokeObjectURL(url);
                document.getElementById('loading-status').classList.add('hidden');
                window.showErrorModal("No se pudo cargar la imagen para el escaneo QR.");
            };
            img.src = url;
        }

        function startScanner() {
            // Use multiCupsAddType for the check if we are in MultiCups mode
            const currentTypeCheck = currentTariffType === 'MULTICUPS' ? multiCupsAddType : currentTariffType;

            if (currentTypeCheck !== '2.0TD') {
                return window.showErrorModal("El esc√°ner QR solo es compatible con la tarifa 2.0 TD.");
            }
            if (currentTariffs['2.0TD'].length === 0) {
                 return window.showErrorModal("Cargando tarifas para esta modalidad. Por favor, espere.");
            }
            if (scannerRunning) return;
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.remove('hidden');
            document.getElementById('scanner-view').classList.add('flex');
            
            scannerRunning = true;
            video = document.createElement('video');
            video.autoplay = true; video.playsInline = true;
            canvas = document.createElement('canvas'); canvasCtx = canvas.getContext('2d');
            document.getElementById('interactive').innerHTML = '';
            document.getElementById('interactive').appendChild(video);
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
                stream = s; video.srcObject = s;
                video.onloadedmetadata = () => { video.play(); scanLoop(); };
            }).catch(e => { console.error(e); stopScanner(); cancelScanner(); window.showErrorModal("Error al acceder a la c√°mara. Intente subir una imagen."); });
        }
        function scanLoop() {
            if (!scannerRunning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { animationFrameId = requestAnimationFrame(scanLoop); return; }
            if (canvas.width !== video.videoWidth) { canvas.width = video.videoWidth; canvas.height = video.videoHeight; }
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) { handleQRRead(code.data); } else { animationFrameId = requestAnimationFrame(scanLoop); }
        }
        function stopScanner() {
            scannerRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (stream) stream.getTracks().forEach(t => t.stop());
            video = null; stream = null;
        }
        function capturePhoto() {
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
            stopScanner();
            document.getElementById('loading-status').textContent = "Procesando foto...";
            document.getElementById('loading-status').classList.remove('hidden');
            
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            document.getElementById('loading-status').classList.add('hidden');
            if (code) handleQRRead(code.data);
            else {  
                window.showErrorModal("No se detect√≥ ning√∫n QR. Aseg√∫rese de que el c√≥digo est√© bien enfocado.");  
                startScanner();  
            }
        }
        
        function handleQRRead(raw) {
            stopScanner();
            const p = {};
            raw.split('&').forEach(part => {  
                let [key, ...rest] = part.split('=');
                let value = rest.join('=');
                try { p[key] = decodeURIComponent(value || '').replace(',', '.'); } catch (e) { p[key] = value || ''; }
            });
            
            let billingDays = 30;  
            let dateRangeStr = "No disponible";  
            let startDateStr = null;  
            let endDateStr = null;
            const isoDateRegex = /(\d{4}-\d{2}-\d{2})/i;
            const dmyDateRegex = /(\d{2}\/\d{2}\/\d{4})/i;  
            
            const iniF_key = Object.keys(p).find(k => k.toLowerCase() === 'inif');
            const finF_key = Object.keys(p).find(k => k.toLowerCase() === 'finf');  
            const iniA_key = Object.keys(p).find(k => k.toLowerCase() === 'inia');  
            let rawStartDate = iniF_key ? p[iniF_key] : null;
            let rawEndDate = finF_key ? p[finF_key] : (iniA_key ? p[iniA_key] : null);  
            
            if (rawStartDate) { let match = rawStartDate.match(isoDateRegex); if (match) { startDateStr = formatIsoToDmy(match[1]); } else { match = rawStartDate.match(dmyDateRegex); if (match) startDateStr = match[1]; } }
            if (rawEndDate) { let match = rawEndDate.match(isoDateRegex); if (match) { endDateStr = formatIsoToDmy(match[1]); } else { match = rawEndDate.match(dmyDateRegex); if (match) endDateStr = match[1]; } }
            
            if (startDateStr && endDateStr) {
                billingDays = calculateDays(startDateStr, endDateStr);
                dateRangeStr = `${startDateStr} - ${endDateStr}`;
            }

            const directData = {
                cups: p.cups || 'QR SCAN',
                dias_facturados: billingDays,
                importe_total: parseFloat(p.imp || 0), // FIX: asegurar que es float, default a 0
                potencia_p1_kw: parseFloat(p.pP1 || 0),
                potencia_p2_kw: parseFloat(p.pP2 || 0),
                // Solo se reciben 3 consumos del QR de la CNMC (P1, P2, P3 -> Punta, Llano, Valle)
                consumo_punta: parseFloat(p.cfP1 || 0),
                consumo_llano: parseFloat(p.cfP2 || 0),
                consumo_valle: parseFloat(p.cfP3 || 0),
                fechas: dateRangeStr,
                rawQR: raw  
            };
            
            const isMultiCupsMode = currentTariffType === 'MULTICUPS';

            if (directData.importe_total <= 0) return window.showErrorModal("QR incompleto. No se detect√≥ el Importe Total de la factura.");

            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('loading-status').classList.add('hidden');

            if (isMultiCupsMode) {
                // En modo MultiCups, el QR solo puede ser 2.0TD
                // Creamos un objeto que imita el input manual
                const dataForSave = { ...directData, originalTariffType: '2.0TD' };  

                // Forzamos 2.0TD para la confirmaci√≥n
                tempQrData = dataForSave;
                // El tipo de tarifa a sugerir para la confirmaci√≥n es el seleccionado en la vista saga (o 2.0TD por defecto si es QR)
                const defaultTariffForConfirmation = multiCupsAddType || '2.0TD';
                document.getElementById('confirm-tariff-select').value = defaultTariffForConfirmation;  
                document.getElementById('confirm-tariff-select').innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos - Se mapear√°n P1/P2/P3)</option>`;

                // Mostrar modal de confirmaci√≥n (permitiendo al usuario cambiar a 3.0TD si lo necesita)
                showQRConfirmationModal(dataForSave);
            } else {
                // Modo Individual: Precarga inputs y compara directamente si es 2.0TD
                document.getElementById('input-cups').value = directData.cups;
                document.getElementById('input-total-bill').value = directData.importe_total;
                document.getElementById('input-billing-days').value = directData.dias_facturados;
                document.getElementById('input-p1-kw').value = directData.potencia_p1_kw;
                document.getElementById('input-p2-kw').value = directData.potencia_p2_kw;
                document.getElementById('input-e1-kwh').value = directData.consumo_punta;
                document.getElementById('input-e2-kwh').value = directData.consumo_llano;
                document.getElementById('input-e3-kwh').value = directData.consumo_valle;
                
                // Aseguramos que los 6 periodos est√©n ocultos si es 2.0TD.
                toggleMultiCupsInputPeriods(currentTariffType, 'input');

                if (currentTariffType === '2.0TD' && currentTariffs['2.0TD'].length > 0) {
                    compareOffers(directData);
                } else if (currentTariffs[currentTariffType]?.length > 0) {
                     window.showMessageModal(`QR le√≠do. Por favor, revise y complete los datos faltantes para tarifas ${currentTariffType}.`, "Completar Datos Manuales");
                     document.getElementById('manual-input-modal').classList.remove('hidden');
                     document.getElementById('manual-input-modal').classList.add('flex');
                } else {
                    window.showErrorModal("Las tarifas no han cargado a√∫n. Por favor, intente de nuevo.");
                }
            }
        }

        // --- FUNCIONES MULTICUPS A√ëADIDAS ---

        function showQRConfirmationModal(data) {
            tempQrData = data;
            const modal = document.getElementById('qr-confirm-modal');
            const summaryEl = document.getElementById('qr-data-summary');
            const selectEl = document.getElementById('confirm-tariff-select');
            const selectorWrapper = document.getElementById('tariff-selector-wrapper');
            
            // Si estamos en MultiCups Mode, ocultamos el selector
            if (currentTariffType === 'MULTICUPS') {
                // OCULTAR el selector completo
                selectorWrapper.style.display = 'none';
                
                // Establecer el valor (aunque est√© oculto)
                selectEl.value = multiCupsAddType;
                
                // Actualizar t√≠tulo y descripci√≥n
                modal.querySelector('h3').textContent = `Confirmar Suministro MultiCups (${multiCupsAddType})`;
                modal.querySelector('p').textContent = `Revisa los datos extra√≠dos del QR antes de a√±adir este suministro a la lista.`;
            } else {
                // Modo Individual: MOSTRAR el selector
                selectorWrapper.style.display = 'block';
                
                // Opciones del selector
                selectEl.innerHTML = `<option value="2.0TD">2.0 TD (Punta, Llano, Valle)</option><option value="3.0TD">3.0 TD (6 Periodos)</option>`;
                selectEl.value = data.originalTariffType && data.originalTariffType !== '6.1TD' ? data.originalTariffType : '2.0TD';
                
                // Textos originales
                modal.querySelector('h3').textContent = `Confirmar Suministro`;
                modal.querySelector('p').textContent = `Revisa los datos extra√≠dos y selecciona el tipo de tarifa para a√±adir a la lista.`;
            }

            summaryEl.innerHTML = `
                <p class="font-bold text-slate-800 mb-2">Datos Extra√≠dos del QR</p>
                <div class="grid grid-cols-2 gap-1 text-xs">
                    <span>CUPS:</span><span class="font-mono text-right">${data.cups}</span>
                    <span>D√≠as Fact:</span><span class="font-mono text-right">${data.dias_facturados}</span>
                    <span>Total Factura:</span><span class="font-mono text-right">${data.importe_total.toFixed(2)} ‚Ç¨</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">Potencias (kW):</span>
                    <span>P1:</span><span class="font-mono text-right">${data.potencia_p1_kw.toFixed(2)}</span>
                    <span>P2:</span><span class="font-mono text-right">${data.potencia_p2_kw.toFixed(2)}</span>
                    <span class="col-span-2 border-t pt-1 mt-1 font-bold">Consumos (kWh):</span>
                    <span>Punta (E1):</span><span class="font-mono text-right">${data.consumo_punta}</span>
                    <span>Llano (E2):</span><span class="font-mono text-right">${data.consumo_llano}</span>
                    <span>Valle (E3):</span><span class="font-mono text-right">${data.consumo_valle}</span>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        document.getElementById('confirm-save-supply-btn').onclick = () => {
            if (!tempQrData) return;
            const tariffType = document.getElementById('confirm-tariff-select').value;
            
            saveSupply(tempQrData, tariffType);
            
            document.getElementById('qr-confirm-modal').classList.add('hidden');
            tempQrData = null;  
        };

        function saveSupply(data, tariffType) {
            const tariffsToCompare = currentTariffs[tariffType];
            if (!tariffsToCompare || tariffsToCompare.length === 0) {
                window.showErrorModal(`Las tarifas ${tariffType} no est√°n cargadas.`);
                return;
            }
            
            // Creamos un nuevo objeto de datos para el c√°lculo, ya que el c√°lculo interno necesita los campos correctos (consumo_p1, consumo_p2, etc.)
            let dataForCalc = { ...data };
            
            const p1_kw = data.potencia_p1_kw || 0;
            const p2_kw = data.potencia_p2_kw || 0;
            const p3_kw_input = data.potencia_p3_kw || 0;
            const e4_kwh_input = data.consumo_p4 || 0;

            // 1. Manejo de mapeo de Potencias y Consumos
            // Simplificamos la condici√≥n, ya que solo 3.0TD es de alto voltaje
            if (tariffType === '3.0TD') {
                // Verificar si se introdujeron manualmente los 6 periodos
                const isManual6PeriodInput = p3_kw_input > 0 || e4_kwh_input > 0 || (data.consumo_p4 > 0 || data.consumo_p5 > 0 || data.consumo_p6 > 0);
                
                if (!isManual6PeriodInput) {
                    // Si es QR o Input Manual simplificado (solo 3 consumos/2 potencias)
                    // Heur√≠stica: Propagar las potencias P1 y P2 a los 6 periodos (P1->P1/P3/P5, P2->P2/P4/P6)
                    // Los consumos E1/E2/E3 (Punta/Llano/Valle) van a P1/P2/P3, y el resto es cero.
                    
                    dataForCalc.potencia_p3_kw = p1_kw;
                    dataForCalc.potencia_p4_kw = p2_kw;
                    dataForCalc.potencia_p5_kw = p1_kw;  
                    dataForCalc.potencia_p6_kw = p2_kw;  
                    
                    dataForCalc.consumo_p1 = data.consumo_punta || 0; // E1 (Punta)
                    dataForCalc.consumo_p2 = data.consumo_llano || 0; // E2 (Llano)
                    dataForCalc.consumo_p3 = data.consumo_valle || 0; // E3 (Valle)
                    dataForCalc.consumo_p4 = 0;
                    dataForCalc.consumo_p5 = 0;
                    dataForCalc.consumo_p6 = 0;
                    
                } else {
                    // Es una entrada manual completa de 6 periodos
                    for(let i=1; i<=6; i++) {
                        dataForCalc[`consumo_p${i}`] = data[`consumo_p${i}`] || 0;
                        dataForCalc[`potencia_p${i}_kw`] = data[`potencia_p${i}_kw`] || 0;
                    }
                }
            } else if (tariffType === '2.0TD') {
                 // Para 2.0TD, aseguramos que los campos 'consumo_punta/llano/valle' est√°n llenos.
                 dataForCalc.consumo_punta = data.consumo_punta !== undefined ? data.consumo_punta : (data.consumo_p1 || 0);
                 dataForCalc.consumo_llano = data.consumo_llano !== undefined ? data.consumo_llano : (data.consumo_p2 || 0);
                 dataForCalc.consumo_valle = data.consumo_valle !== undefined ? data.consumo_valle : (data.consumo_p3 || 0);
                 // Solo usamos potencias P1 y P2
                 dataForCalc.potencia_p1_kw = data.potencia_p1_kw || 0;
                 dataForCalc.potencia_p2_kw = data.potencia_p2_kw || 0;
            }
            
            // 2. Ejecutar la comparaci√≥n con el objeto de datos corregido
            const results = tariffsToCompare.map(t => calculateTariffCost(t, dataForCalc, tariffType));
            
            let bestOverall = null; // Absolute best (DRK or Power Cup)
            let bestDrk = null;  // Best DRK only
            
            results.forEach(r => {
                // Siempre comparamos por el coste anual
                const annualCost = r.totalAnnual;
                
                // Best overall is the one with the lowest annual cost
                if (!bestOverall || annualCost < bestOverall.totalAnnual) {
                    bestOverall = r;
                }

                // Best DRK is the DRK one with the lowest annual cost
                if (r.offer.isDrk && r.offer.name !== 'Tu Tarifa Actual') {
                    if (!bestDrk || annualCost < bestDrk.totalAnnual) {
                            bestDrk = r;
                    }
                }
            });
            
            let finalIndividualResult = bestOverall;
            
            // --- GUARDAR OFERTAS CON AHORRO POSITIVO PARA SELECCI√ìN MANUAL ---
            availableOffers = results.filter(r => {
                const hasPositiveSavings = r.savings > 0 && r.totalAnnual < r.originalBillAnnual;
                
                // Si modo es "DRK √öNICAMENTE", filtrar solo ofertas DRK
                if (comparisonMode === 'drk_only') {
                    return hasPositiveSavings && r.offer.isDrk;
                }
                
                // En otros modos, mostrar todas las ofertas con ahorro
                return hasPositiveSavings;
            });
            
            // --- L√ìGICA DE SELECCI√ìN INDIVIDUAL SEG√öN MODO DE COMPARACI√ìN ---
            let brand = activeBrand;
            
            // Si hay una oferta seleccionada manualmente (desde el modal), usarla
            if (manuallySelectedOffer) {
                finalIndividualResult = manuallySelectedOffer;
                
                // Aplicar branding seg√∫n la oferta seleccionada
                if (finalIndividualResult.offer.isDrk) {
                    brand = BRANDS.DRK;
                } else {
                    brand = BRANDS.POWER_CUP;
                }
            } else {
                // Modo autom√°tico seg√∫n el modo de comparaci√≥n
                if (comparisonMode === 'overall_best') {
                    // Modo POWER CUP: Buscar la mejor oferta absoluta (con o sin DRK)
                    finalIndividualResult = bestOverall;
                    
                    // Aplicar branding seg√∫n qui√©n gan√≥
                    if (finalIndividualResult.offer.isDrk) {
                        brand = BRANDS.DRK;
                    } else {
                        brand = BRANDS.POWER_CUP;
                    }
                } else {
                    // Modos DRK (drk_only, drk_prioritized)
                    if (comparisonMode === 'drk_only') {
                        finalIndividualResult = bestDrk || bestOverall;
                        // DRK √öNICAMENTE: SIEMPRE mantener branding DRK (azul)
                        brand = BRANDS.DRK;
                    } else if (comparisonMode === 'drk_prioritized') {
                        // Usar DRK si tiene ahorro, sino usar la mejor absoluta
                        finalIndividualResult = (bestDrk && bestDrk.totalAnnual < bestDrk.originalBillAnnual) ? bestDrk : bestOverall;
                        
                        // DRK PRIORITARIO: Solo cambiar a POWER_CUP si gan√≥ una comercializadora NO-DRK
                        if (finalIndividualResult.offer.isDrk) {
                            brand = BRANDS.DRK;
                        } else {
                            brand = BRANDS.POWER_CUP;
                        }
                    }
                }
            }

            if (!finalIndividualResult) return window.showErrorModal("No se pudo calcular el ahorro para esta CUPS.");
            
            // Recalcular el ahorro basado en el resultado final seleccionado
            finalIndividualResult.savings = finalIndividualResult.originalBillAnnual - finalIndividualResult.totalAnnual;
            
            // Manejar casos sin ahorro
            if (finalIndividualResult.savings <= 0) {
                finalIndividualResult.isNegativeSavings = true;
                finalIndividualResult.savings = 0;
                finalIndividualResult.totalAnnual = finalIndividualResult.originalBillAnnual;
                finalIndividualResult.offer = { 
                    name: "Tu Tarifa Actual", 
                    description: "Es la mejor opci√≥n detectada", 
                    isDrk: false 
                };
                // Mantener el branding seg√∫n el modo seleccionado
                brand = comparisonMode === 'overall_best' ? BRANDS.POWER_CUP : BRANDS.DRK;
            }

            // Apply branding here just for consistency before saving/showing modal
            applyBrandStyles(brand);
            
            // Ensure the correct tariff type used for calculation is stored
            finalIndividualResult.originalTariffType = tariffType;  

            // Copy back the 6-period power and consumption values in case they were generated (for 3.0TD/6.1TD)
            if (tariffType === '3.0TD') {
                for (let i = 1; i <= 6; i++) {
                    finalIndividualResult[`consumo_p${i}`] = dataForCalc[`consumo_p${i}`] || 0;
                    finalIndividualResult[`potencia_p${i}_kw`] = dataForCalc[`potencia_p${i}_kw`] || 0;
                }
            }
            
            // --- NUEVA L√ìGICA: Modal de decisi√≥n en POWER CUP MultiCups ---
            // Si es modo POWER CUP y hay m√°s de 1 oferta, permitir elegir
            if (comparisonMode === 'overall_best' && availableOffers.length > 1) {
                console.log('POWER CUP MultiCups: Showing decision modal with', availableOffers.length, 'offers');
                
                // Guardar temporalmente el resultado para usarlo despu√©s
                lastComparisonResult = finalIndividualResult;
                lastComparisonResult.isMulti = false;
                lastComparisonResult._multiCupsContext = {
                    tariffType: tariffType,
                    dataForCalc: dataForCalc
                };
                
                // Mostrar modal de decisi√≥n
                showOfferDecisionModal();
                return; // No a√±adir todav√≠a, esperar decisi√≥n del usuario
            }
            
            // A√±adir directamente si NO es POWER CUP o solo hay 1 oferta
            multiCupsData.push(finalIndividualResult);
            
            // Actualizar UI y volver a la vista SAGA
            document.getElementById('tariff-display-badge').textContent = multiCupsData.length;
            
            window.showMessageModal(`Suministro ${finalIndividualResult.cups} (${tariffType}) a√±adido. Total: ${multiCupsData.length}`, "Suministro A√±adido");
            
            document.getElementById('initial-view').classList.add('hidden');
            showMultiCupsSagaView();
        }

        // --- FETCH & PARSE (Actualizado para M√∫ltiples Tarifas) ---

        async function fetchTariffsForMultiCups() {
            const statusEl = document.getElementById('loading-status-saga');
            statusEl.textContent = `Cargando tarifas 2.0TD y 3.0TD...`;
            updateMultiCupsSagaView(); // Update visibility to show loading
            
            // Fetch 2.0TD and 3.0TD tariffs simultaneously
            await Promise.all([
                fetchTariffsFromSheet('2.0TD'),
                fetchTariffsFromSheet('3.0TD')  
            ]);
            
            updateMultiCupsSagaView(); // Update visibility to hide loading and enable buttons
            
            if (currentTariffs['2.0TD'].length === 0 || currentTariffs['3.0TD'].length === 0) {
                 // Use a more specific error message based on which failed
                 const failed = [];
                 if (currentTariffs['2.0TD'].length === 0) failed.push('2.0TD');
                 if (currentTariffs['3.0TD'].length === 0) failed.push('3.0TD');
                 window.showErrorModal(`Error: Las tarifas ${failed.join(' y ')} para MultiCups no se han cargado correctamente. Intente de nuevo.`);
            }
        }
        
        async function fetchTariffsFromSheet(tariffType) {
            const config = TARIFF_CONFIG[tariffType];
            const sheetId = config.sheetId;

            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=0&t=${Date.now()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error red para ${tariffType}`);
                const text = await response.text();
                currentTariffs[tariffType] = parseCSV(text, tariffType);
                
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    const count = currentTariffs[currentTariffType].length;
                    document.getElementById('tariff-display-badge').textContent = count;
                }

            } catch (e) {
                console.error(`Error al cargar ${tariffType}:`, e);
                currentTariffs[tariffType] = [];  
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('tariff-display-badge').textContent = 'Error';
                }
            } finally {
                if (currentTariffType !== 'MULTICUPS' && tariffType === currentTariffType) {
                    document.getElementById('loading-status').classList.add('hidden');
                }
            }
        }

        function parseCSV(text, tariffType) {
             const lines = text.trim().split('\n');
             if (lines.length < 2) return [];
             
             const rawHeader = lines[0];
             const delimiter = rawHeader.includes(';') ? ';' : ',';
             
             const headers = rawHeader.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
             const data = [];

             for(let i=1; i<lines.length; i++) {
                 const row = lines[i].trim();
                 if(!row) continue;
                 
                 const regex = new RegExp(`(?:^|${delimiter})(\"(?:[^\"]|\"\")*\"|[^${delimiter}]*)`,"g");
                 const values = [];
                 let match = null;
                 regex.lastIndex = 0;  
                 // Custom parsing to handle quoted fields correctly
                 let lastIndex = 0;
                 while(match = regex.exec(row)){
                      let val = match[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                      // If the first capture group starts with the delimiter, it means the content is empty or the previous field was empty.
                      if (match.index > lastIndex) {
                           // Add empty string for missed fields
                           for (let j = 0; j < (match.index - lastIndex) / delimiter.length; j++) {
                                values.push('');
                           }
                      }
                      values.push(val.trim());
                      lastIndex = match.index + match[0].length;
                 }
                 // Add trailing empty fields
                 if (values.length < headers.length) {
                      for (let j = values.length; j < headers.length; j++) {
                           values.push('');
                      }
                 }


                 if(values.length < headers.length) continue;

                 let item = { cups_match: [tariffType] };
                 headers.forEach((h, idx) => {
                      let val = values[idx];
                       if (h.includes('price') || h.includes('potencia') || h === 'descuento') {
                            val = parseFloat(val?.replace(',', '.') || 0);
                             if(isNaN(val)) val = 0;
                       }
                       item[h] = val;
                 });

                 item.isDrk = item.name?.toUpperCase().includes('DRK');
                 
                 // Check a mandatory field to ensure it's a valid row (using p1_price as a key indicator)
                 if(item.p1_price !== undefined) data.push(item);  
               }
               return data;
        }
    </script>
</body>
</html>
